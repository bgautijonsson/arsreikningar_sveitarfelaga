---
title: "Ársreikningar Sveitarfélaga"
author: 
    -   name: "Brynjólfur Gauti Guðrúnar Jónsson"
        url: "https://twitter.com/bgautijonsson"
        affiliation: "Tölfræði, Raunvísindadeild Háskóla Íslands"
        affiliation-url: "https://www.hi.is/tolfraedi_0"
date: today
format: 
    html:
        code-fold: true
        toc: true
        toc-location: right
        toc-title: Efnisyfirlit
editor: source
theme: flatly
title-block-banner: true
standalone: true
self-contained: true
---


```{r}
#| include: false

library(cowplot)
library(tidyverse)
library(scales)
library(pxweb)
library(ggthemes)
library(kableExtra)
library(gganimate)
library(lubridate)
library(geomtextpath)
library(ggtext)
library(here)
library(readxl)
library(janitor)
```

# Gögn

```{r}
efnahagur <- read_excel("net-efnahagsreikningur.xlsx", skip = 4) |> 
    clean_names() |> 
    fill(ar, sveitarfelag, hluti) |> 
    filter(
        tegund2 %in% c("Veltufjármunir Total", "Varanlegir rekstrarfjármunir", "Áhættufjármunir og langtímakröfur",
                       "Skuldbindingar", "Langtímaskuldir", "Skammtímaskuldir", "Eigið fé") | tegund %in% c("Skammtímakröfur á eigin fyrirtæki")
    ) |> 
    mutate(tegund2 = ifelse(is.na(tegund2), tegund, tegund2) |> str_replace(" Total", "")) |> 
    select(-tegund) |> 
    mutate(ar = parse_number(ar),
           sveitarfelag = str_sub(sveitarfelag, start = 6))
```

```{r}
rekstur <- read_excel("net-rekstrarreikningur.xlsx", skip = 4) |> 
    clean_names() |> 
    fill(ar, sveitarfelag, hluti) |> 
    filter(tegund2 %in% c("Gjöld Total", "Tekjur Total") | tegund %in% c("Afskriftir", "Fjármagnsliðir")) |> 
    mutate(tegund2 = ifelse(is.na(tegund2), tegund, tegund2) |> str_replace(" Total", "")) |> 
    select(-tegund) |> 
    mutate(ar = parse_number(ar),
           sveitarfelag = str_sub(sveitarfelag, start = 6))
```




```{r}
sjodsstreymi <- read_excel("net-sjodsstreymi.xlsx", skip = 4) |> 
    clean_names() |> 
    fill(ar, sveitarfelag, hluti, tegund2) |> 
    mutate(ar = parse_number(ar),
           sveitarfelag = str_sub(sveitarfelag, start = 6)) |> 
    filter(tegund2 == "Veltufé frá rekstri Total" | tegund %in% c("Afborganir langtímalána", "Aðrar fjármögnunarhreyfingar")) |>
    mutate(tegund2 = ifelse(is.na(tegund), tegund2, tegund) |> str_replace(" Total", "")) |> 
    select(-tegund)
```

```{r}
mannfjoldi <- pxweb_get(
    url ="https://px.hagstofa.is:443/pxis/api/v1/is/Ibuar/mannfjoldi/2_byggdir/sveitarfelog/MAN02005.px", 
    query = list(
        "Sveitarfélag" = c("*"),
        "Aldur" = c("-1"),
        "Ár" = c("*"),
        "Kyn" = c("0")
    ),
    verbose = FALSE
) |> 
    as.data.frame() |> 
    as_tibble() |> 
    janitor::clean_names() |> 
    rename(mannfjoldi = mannfjoldi_eftir_sveitarfelagi_kyni_og_aldri_1_januar_1998_2022) |> 
    mutate(ar = parse_number(ar)) |> 
    filter(sveitarfelag != "Alls") |> 
    select(sveitarfelag, ar, mannfjoldi) |> 
    mutate(sveitarfelag = fct_recode(sveitarfelag,
                                     "Akureyrarkaupstaður" = "Akureyrarbær"))
```


```{r}
gogn_2021 <- read_csv("arsreikningar_2021_drive.csv")
```



```{r}
d <- efnahagur |> 
    select(-tegund3) |> 
    pivot_wider(names_from = tegund2, values_from = total) |> 
    inner_join(
        rekstur |> 
            pivot_wider(names_from = tegund2, values_from = total),
        by = c("ar", "sveitarfelag", "hluti")
    ) |> 
    inner_join(
        sjodsstreymi |> 
            pivot_wider(names_from = tegund2, values_from = total),
        by = c("ar", "sveitarfelag", "hluti")
    ) |> 
    mutate(heildarskuldir = `Skuldbindingar` + `Langtímaskuldir` + `Skammtímaskuldir`,
           eignir = `Varanlegir rekstrarfjármunir` + `Áhættufjármunir og langtímakröfur` + `Veltufjármunir`) |> 
    select(ar, sveitarfelag, hluti, heildarskuldir, eignir, tekjur = "Tekjur", gjold = "Gjöld", afskriftir = "Afskriftir", fjarmagnslidir = "Fjármagnsliðir",
           eigid_fe = "Eigið fé", veltufjarmunir = "Veltufjármunir", skammtimakrofur_eigin_fyrirtaeki = "Skammtímakröfur á eigin fyrirtæki",
           skammtimaskuldir = "Skammtímaskuldir", 
           veltufe = "Veltufé frá rekstri") |> 
    bind_rows(
        gogn_2021
    ) |> 
    mutate_at(vars(heildarskuldir:veltufe), ~ .x * 1000) |> 
    inner_join(mannfjoldi,
               by = c("ar", "sveitarfelag")) |> 
    mutate(nettoskuldir = heildarskuldir - veltufjarmunir + skammtimakrofur_eigin_fyrirtaeki,
           skuldir_hlutf_tekjur = heildarskuldir / tekjur,
           nettoskuldir_hlutf_tekjur = nettoskuldir / tekjur,
           veltufjarhlutfall = veltufjarmunir / skammtimaskuldir,
           eignahlutf = eignir / heildarskuldir,
           rekstrarnidurstada = tekjur - gjold + fjarmagnslidir,
           rekstrarnidurstada_hlutf = rekstrarnidurstada / tekjur,
           framlegd = rekstrarnidurstada + afskriftir,
           framlegd_hlutf = framlegd / tekjur,
           eiginfjarhlutfall = eigid_fe / eignir,
           skuldahlutfall = 1 - eiginfjarhlutfall,
           skuldir_per_ibui = heildarskuldir / mannfjoldi,
           veltufe_hlutf_tekjur = veltufe / tekjur,
           hluti = fct_recode(hluti,
                              "A-hluti" = "A_hluti",
                              "A og B-hluti" = "A_og_B_hluti")) |> 
    filter(hluti == "A-hluti",
           sveitarfelag %in% efnahagur$sveitarfelag)

d |> write_csv("arsreikningagogn_ahluti.csv")
```

```{r}
plot_year <- 2014
```


# Myndir

## A hluti

### Skuldir

#### Skuldir sem hlutfall af árstekjum

```{r, fig.asp = 0.5, fig.width = 10, out.width = "100%"}
plot_dat <- d |> 
    group_by(sveitarfelag) |> 
    mutate(label = ifelse(ar == max(ar), sveitarfelag, NA_character_)) |> 
    ungroup() |> 
    mutate(x = ar,
           y = skuldir_hlutf_tekjur,
           y = case_when(sveitarfelag == "Mosfellsbær" ~ y + 0,
                         sveitarfelag == "Kópavogsbær" ~ y - 0.015,
                         sveitarfelag == "Garðabær" ~ y + 0.015,
                         sveitarfelag == "Reykjavíkurborg" ~ y + 0.015,
                         TRUE ~ y)) |> 
    filter(ar >= plot_year)

p <- plot_dat |> 
    ggplot(aes(ar, skuldir_hlutf_tekjur, col = sveitarfelag)) +
    geom_hline(yintercept = 1, lty = 2) +
    geom_line() +
    geom_point() +
    geom_text(data = plot_dat |> group_by(sveitarfelag) |> filter(ar == max(ar)),
              aes(label = label, x = x, y = y), nudge_x = 0.1, hjust = 0, size = 4) +
    geom_rangeframe(col = "black") +
    scale_x_continuous(breaks = plot_year:2021, 
                       limits = c(plot_year, 2022.3)) +
    scale_y_continuous(breaks = c(range(plot_dat$skuldir_hlutf_tekjur), 0.75, 1, 1.25, 1.5, 2), 
                       labels = label_percent(accuract = 1)) +
    scale_colour_brewer(type = "qual", palette = "Dark2") +
    theme_tufte() +
    theme(legend.position = "none") +
    labs(x = NULL,
         y = NULL,
         title = "Skuldir sveitafélaga sem hlutfall af árstekjum (A-hluti)",
         caption = "Kóði og gögn: https://github.com/bgautijonsson/arsreikningar_sveitarfelaga")

p

ggsave(plot = p,
       filename = "skuldir_hlutfall_arstekjum.png",
       width = 8, height = 0.5 * 8, scale = 1.3, bg = "white")
```

#### Skuldir á íbúa

```{r, fig.asp = 0.5, fig.width = 10, out.width = "100%"}
plot_dat <- d |> 
    mutate(hlutf = heildarskuldir / mannfjoldi) |> 
    group_by(sveitarfelag) |> 
    mutate(label = ifelse(ar == max(ar), sveitarfelag, NA_character_)) |> 
    ungroup() |> 
    mutate(x = ar,
           y = hlutf,
           y = case_when(sveitarfelag == "Mosfellsbær" ~ y + 1e4,
                         sveitarfelag == "Kópavogsbær" ~ y + 5e3,
                         sveitarfelag == "Garðabær" ~ y - 3e4,
                         sveitarfelag == "Hafnarfjarðarkaupstaður" ~ y + 2e4,
                         sveitarfelag == "Reykjavíkurborg" ~ y - 3.5e4,
                         sveitarfelag == "Seltjarnarnesbær" ~ y + 3.5e4,
                         TRUE ~ y)) |> 
    filter(ar >= plot_year)

p <- plot_dat |> 
    ggplot(aes(ar, hlutf, col = sveitarfelag)) +
    geom_line() +
    geom_point() +
    geom_text(data = plot_dat |> group_by(sveitarfelag) |> filter(ar == max(ar)),
              aes(label = label, x = x, y = y), nudge_x = 0.1, hjust = 0, size = 4) +
    geom_rangeframe(col = "black") +
    scale_x_continuous(breaks = plot_year:2021, 
                       limits = c(plot_year, 2022.4)) +
    scale_y_log10(breaks = c(range(plot_dat$hlutf), 3e5, 5e5, 1e6), 
                  labels = label_number(accuracy = 1, suffix = " kr.")) +
    scale_colour_brewer(type = "qual", palette = "Dark2") +
    theme_tufte() +
    theme(legend.position = "none") +
    labs(x = NULL,
         y = NULL,
         title = "Skuldir sveitafélaga á hvern íbúa (A-hluti)",
         caption = "Kóði og gögn: https://github.com/bgautijonsson/arsreikningar_sveitarfelaga")

p

ggsave(plot = p,
       filename = "skuldir_a_ibua.png",
       width = 8, height = 0.5 * 8, scale = 1.3, bg = "white")
```

#### Heildarskuldir

```{r, fig.asp = 0.5, fig.width = 10, out.width = "100%"}
plot_dat <- d |> 
    group_by(sveitarfelag) |> 
    mutate(label = ifelse(ar == max(ar), sveitarfelag, NA_character_)) |> 
    ungroup() |> 
    mutate(x = ar,
           y = heildarskuldir,
           y = case_when(sveitarfelag == "Mosfellsbær" ~ y ,
                         sveitarfelag == "Kópavogsbær" ~ y - 2e9,
                         sveitarfelag == "Garðabær" ~ y,
                         sveitarfelag == "Reykjavíkurborg" ~ y,
                         sveitarfelag == "Hafnarfjarðarkaupstaður" ~ y + 3e9,
                         TRUE ~ y)) |> 
    filter(ar >= plot_year)

p <- plot_dat |> 
    ggplot(aes(ar, heildarskuldir, col = sveitarfelag)) +
    geom_line() +
    geom_point() +
    geom_text(data = plot_dat |> group_by(sveitarfelag) |> filter(ar == max(ar)),
              aes(label = label, x = x, y = y), nudge_x = 0.1, hjust = 0, size = 4) +
    geom_rangeframe(col = "black") +
    scale_x_continuous(breaks = plot_year:2021, 
                       limits = c(plot_year, 2022.4)) +
    scale_y_log10(breaks = c(range(plot_dat$heildarskuldir), 1e10, 3e10, 1e11, 3e11), 
                  labels = label_number(accuracy = 1, suffix = " kr.")) +
    scale_colour_brewer(type = "qual", palette = "Dark2") +
    theme_tufte() +
    theme(legend.position = "none") +
    labs(x = NULL,
         y = NULL,
         title = "Heildarskuldir sveitarfélaga (A-hluti)",
         caption = "Kóði og gögn: https://github.com/bgautijonsson/arsreikningar_sveitarfelaga")


p

ggsave(plot = p,
       filename = "heildarskuldir.png",
       width = 8, height = 0.5 * 8, scale = 1.3, bg = "white")
```

### Aukning skulda

#### Frá 2018

```{r, fig.asp = 0.4, fig.width = 10, out.width = "100%"}
plot_dat <- d |> 
    group_by(sveitarfelag) |> 
    mutate(label = ifelse(ar == max(ar), sveitarfelag, NA_character_),
           skuldaaukning = heildarskuldir / heildarskuldir[ar == 2018]) |> 
    ungroup() |> 
    mutate(x = ar,
           y = skuldaaukning,
           y = case_when(sveitarfelag == "Mosfellsbær" ~ y ,
                         sveitarfelag == "Kópavogsbær" ~ y,
                         sveitarfelag == "Garðabær" ~ y,
                         sveitarfelag == "Reykjavíkurborg" ~ y,
                         sveitarfelag == "Hafnarfjarðarkaupstaður" ~ y,
                         TRUE ~ y)) |> 
    filter(ar >= 2018)

p <- plot_dat |> 
    ggplot(aes(ar, skuldaaukning, col = sveitarfelag)) +
    geom_line() +
    geom_point() +
    geom_text(data = plot_dat |> group_by(sveitarfelag) |> filter(ar == max(ar)),
              aes(label = label, x = x, y = y), nudge_x = 0.02, hjust = 0, size = 4) +
    geom_rangeframe(col = "black") +
    scale_x_continuous(breaks = 2018:2021, 
                       limits = c(NA, 2021.55)) +
    scale_y_continuous(breaks = c(range(plot_dat$skuldaaukning), 1.25, 1.5), 
                       labels = label_number(suffix = "x")) +
    scale_colour_brewer(type = "qual", palette = "Dark2") +
    theme_tufte() +
    theme(legend.position = "none") +
    labs(x = NULL,
         y = NULL,
         title = "Hlutfallsleg aukning heildarskulda sveitarfélaga síðan 2018 (A-hluti)",
         caption = "Kóði og gögn: https://github.com/bgautijonsson/arsreikningar_sveitarfelaga")

p

ggsave(plot = p,
       filename = "skuldaaukning.png",
       width = 8, height = 0.5 * 8, scale = 1.3, bg = "white")
```

#### Frá 2010

```{r, fig.asp = 0.4, fig.width = 10, out.width = "100%"}
plot_dat <- d |> 
    group_by(sveitarfelag) |> 
    mutate(label = ifelse(ar == max(ar), sveitarfelag, NA_character_),
           skuldaaukning = heildarskuldir / heildarskuldir[ar == 2010]) |> 
    ungroup() |> 
    mutate(x = ar,
           y = skuldaaukning,
           y = case_when(sveitarfelag == "Mosfellsbær" ~ y ,
                         sveitarfelag == "Kópavogsbær" ~ y,
                         sveitarfelag == "Garðabær" ~ y,
                         sveitarfelag == "Reykjavíkurborg" ~ y,
                         sveitarfelag == "Hafnarfjarðarkaupstaður" ~ y,
                         TRUE ~ y)) |> 
    filter(ar >= 2010)

p <- plot_dat |> 
    ggplot(aes(ar, skuldaaukning, col = sveitarfelag)) +
    geom_line() +
    geom_point() +
    geom_text(data = plot_dat |> group_by(sveitarfelag) |> filter(ar == max(ar)),
              aes(label = label, x = x, y = y), nudge_x = 0.1, hjust = 0, size = 4) +
    geom_rangeframe(col = "black") +
    scale_x_continuous(breaks = 2010:2021, 
                       limits = c(NA, 2023)) +
    scale_y_continuous(breaks = c(range(plot_dat$skuldaaukning), 1, 1.25, 1.5, 2, 2.5, 3), 
                       labels = label_number(suffix = "x")) +
    scale_colour_brewer(type = "qual", palette = "Dark2") +
    theme_tufte() +
    theme(legend.position = "none") +
    labs(x = NULL,
         y = NULL,
         title = "Hlutfallsleg aukning heildarskulda sveitarfélaga síðan 2010 (A-hluti)",
         caption = "Kóði og gögn: https://github.com/bgautijonsson/arsreikningar_sveitarfelaga")

p

ggsave(plot = p,
       filename = "skuldaaukning_2010.png",
       width = 8, height = 0.5 * 8, scale = 1.3, bg = "white")
```



### Nettó skuldir

#### Nettó skuldir sem hlutfall af árstekjum

```{r, fig.asp = 0.5, fig.width = 10, out.width = "100%"}
plot_dat <- d |> 
    group_by(sveitarfelag) |> 
    mutate(label = ifelse(ar == max(ar), sveitarfelag, NA_character_)) |> 
    ungroup() |> 
    mutate(x = ar,
           y = nettoskuldahlutf,
           y = case_when(sveitarfelag == "Mosfellsbær" ~ y + 0,
                         sveitarfelag == "Kópavogsbær" ~ y + 0.015,
                         sveitarfelag == "Garðabær" ~ y - 0.035,
                         sveitarfelag == "Reykjavíkurborg" ~ y,
                         TRUE ~ y)) |> 
    filter(ar >= plot_year)

p <- plot_dat |> 
    ggplot(aes(ar, nettoskuldahlutf, col = sveitarfelag)) +
    geom_hline(yintercept = 1, lty = 2) +
    geom_line() +
    geom_point() +
    geom_text(data = plot_dat |> group_by(sveitarfelag) |> filter(ar == max(ar)),
              aes(label = label, x = x, y = y), nudge_x = 0.1, hjust = 0, size = 4) +
    geom_rangeframe(col = "black") +
    scale_x_continuous(breaks = plot_year:2021, 
                       limits = c(plot_year, 2022.5)) +
    scale_y_continuous(breaks = c(range(plot_dat$nettoskuldahlutf), 0.75, 1, 1.25, 1.5, 2, 2.5), 
                       labels = label_percent(accuract = 1)) +
    scale_colour_brewer(type = "qual", palette = "Dark2") +
    theme_tufte() +
    theme(legend.position = "none") +
    labs(x = NULL,
         y = NULL,
         title = "Nettóskuldir sveitafélaga sem hlutfall af árstekjum (A-hluti)",
         subtitle = "Nettóskuldir eru heildarskuldir að frádregnum peningalegum eignum án eigin fyrirtækja",
         caption = "Kóði og gögn: https://github.com/bgautijonsson/arsreikningar_sveitarfelaga")

p

ggsave(plot = p,
       filename = "nettoskuldir_hlutfall_arstekjum.png",
       width = 8, height = 0.5 * 8, scale = 1.3, bg = "white")
```

#### Nettó skuldir á íbúa

```{r, fig.asp = 0.5, fig.width = 10, out.width = "100%"}
plot_dat <- d |> 
    mutate(hlutf = nettoskuldir / mannfjoldi) |> 
    group_by(sveitarfelag) |> 
    mutate(label = ifelse(ar == max(ar), sveitarfelag, NA_character_)) |> 
    ungroup() |> 
    mutate(x = ar,
           y = hlutf,
           y = case_when(sveitarfelag == "Mosfellsbær" ~ y + 1e4,
                         sveitarfelag == "Kópavogsbær" ~ y,
                         sveitarfelag == "Garðabær" ~ y,
                         sveitarfelag == "Hafnarfjarðarkaupstaður" ~ y,
                         sveitarfelag == "Reykjavíkurborg" ~ y,
                         sveitarfelag == "Seltjarnarnesbær" ~ y + 3.5e4,
                         TRUE ~ y)) |> 
    filter(ar >= plot_year)

p <- plot_dat |> 
    ggplot(aes(ar, hlutf, col = sveitarfelag)) +
    geom_line() +
    geom_point() +
    geom_text(data = plot_dat |> group_by(sveitarfelag) |> filter(ar == max(ar)),
              aes(label = label, x = x, y = y), nudge_x = 0.05, hjust = 0, size = 4) +
    geom_rangeframe(col = "black") +
    scale_x_continuous(breaks = plot_year:2021, 
                       limits = c(plot_year, 2022.4)) +
    scale_y_continuous(breaks = c(range(plot_dat$hlutf), 3e5, 5e5, 1e6, 2e6), 
                       labels = label_number(accuracy = 1, suffix = " kr.")) +
    scale_colour_brewer(type = "qual", palette = "Dark2") +
    theme_tufte() +
    theme(legend.position = "none") +
    labs(x = NULL,
         y = NULL,
         title = "Nettóskuldir sveitafélaga á hvern íbúa (A-hluti)",
         subtitle = "Nettóskuldir eru heildarskuldir að frádregnum peningalegum eignum án eigin fyrirtækja",
         caption = "Kóði og gögn: https://github.com/bgautijonsson/arsreikningar_sveitarfelaga")

p

ggsave(plot = p,
       filename = "nettoskuldir_a_ibua.png",
       width = 8, height = 0.5 * 8, scale = 1.3, bg = "white")
```

#### Aukning nettóskulda

##### Frá 2018

```{r, fig.asp = 0.4, fig.width = 10, out.width = "100%"}
plot_dat <- d |> 
    group_by(sveitarfelag) |> 
    mutate(label = ifelse(ar == max(ar), sveitarfelag, NA_character_),
           skuldaaukning = nettoskuldir / nettoskuldir[ar == 2018]) |> 
    ungroup() |> 
    mutate(x = ar,
           y = skuldaaukning,
           y = case_when(sveitarfelag == "Mosfellsbær" ~ y + 0.01,
                         sveitarfelag == "Kópavogsbær" ~ y,
                         sveitarfelag == "Garðabær" ~ y - 0.01,
                         sveitarfelag == "Reykjavíkurborg" ~ y,
                         sveitarfelag == "Hafnarfjarðarkaupstaður" ~ y,
                         TRUE ~ y)) |> 
    filter(ar >= 2018)

p <- plot_dat |> 
    ggplot(aes(ar, skuldaaukning, col = sveitarfelag)) +
    geom_hline(yintercept = 1, lty = 2, alpha = 0.7) +
    geom_line() +
    geom_point() +
    geom_text(data = plot_dat |> group_by(sveitarfelag) |> filter(ar == max(ar)),
              aes(label = label, x = x, y = y), nudge_x = 0.02, hjust = 0, size = 4) +
    geom_rangeframe(col = "black") +
    scale_x_continuous(breaks = 2018:2021, 
                       limits = c(NA, 2021.55)) +
    scale_y_continuous(breaks = c(range(plot_dat$skuldaaukning), 1.25, 1.5, 2), 
                       labels = label_number(suffix = "x")) +
    scale_colour_brewer(type = "qual", palette = "Dark2") +
    theme_tufte() +
    theme(legend.position = "none") +
    labs(x = NULL,
         y = NULL,
         title = "Hlutfallsleg aukning nettóskulda sveitarfélaga síðan 2018 (A-hluti)",
         subtitle = "Nettóskuldir eru heildarskuldir að frádregnum peningalegum eignum án eigin fyrirtækja",
         caption = "Kóði og gögn: https://github.com/bgautijonsson/arsreikningar_sveitarfelaga")

p

ggsave(plot = p,
       filename = "nettoskuldaaukning.png",
       width = 8, height = 0.5 * 8, scale = 1.3, bg = "white")
```

##### Frá 2010

```{r, fig.asp = 0.4, fig.width = 10, out.width = "100%"}
plot_dat <- d |> 
    group_by(sveitarfelag) |> 
    mutate(label = ifelse(ar == max(ar), sveitarfelag, NA_character_),
           skuldaaukning = nettoskuldir / nettoskuldir[ar == 2010]) |> 
    ungroup() |> 
    mutate(x = ar,
           y = skuldaaukning,
           y = case_when(sveitarfelag == "Mosfellsbær" ~ y ,
                         sveitarfelag == "Kópavogsbær" ~ y,
                         sveitarfelag == "Garðabær" ~ y - 0.09,
                         sveitarfelag == "Reykjavíkurborg" ~ y + 0.09,
                         sveitarfelag == "Hafnarfjarðarkaupstaður" ~ y + 0.25,
                         TRUE ~ y)) |> 
    filter(ar >= 2010)

p <- plot_dat |> 
    ggplot(aes(ar, skuldaaukning, col = sveitarfelag)) +
    geom_hline(yintercept = 1, lty = 2, alpha = 0.7) +
    geom_line() +
    geom_point() +
    geom_text(data = plot_dat |> group_by(sveitarfelag) |> filter(ar == max(ar)),
              aes(label = label, x = x, y = y), nudge_x = 0.1, hjust = 0, size = 4) +
    geom_rangeframe(col = "black") +
    scale_x_continuous(breaks = 2010:2021, 
                       limits = c(NA, 2023.2)) +
    scale_y_continuous(breaks = c(range(plot_dat$skuldaaukning), 1, 1.5, 3), 
                       labels = label_number(suffix = "x")) +
    scale_colour_brewer(type = "qual", palette = "Dark2") +
    theme_tufte() +
    theme(legend.position = "none") +
    labs(x = NULL,
         y = NULL,
         title = "Hlutfallsleg aukning nettóskulda sveitarfélaga síðan 2010 (A-hluti)",
         subtitle = "Nettóskuldir eru heildarskuldir að frádregnum peningalegum eignum án eigin fyrirtækja",
         caption = "Kóði og gögn: https://github.com/bgautijonsson/arsreikningar_sveitarfelaga")

p

ggsave(plot = p,
       filename = "nettoskuldaaukning_2010.png",
       width = 8, height = 0.5 * 8, scale = 1.3, bg = "white")
```


### Eiginfjárhlutfall

```{r, fig.asp = 0.5, fig.width = 10, out.width = "100%"}
plot_dat <- d |> 
    group_by(sveitarfelag) |> 
    mutate(label = ifelse(ar == max(ar), sveitarfelag, NA_character_)) |> 
    ungroup() |> 
    mutate(x = ar,
           y = eiginfjarhlutfall,
           y = case_when(sveitarfelag == "Mosfellsbær" ~ y + 0,
                         sveitarfelag == "Kópavogsbær" ~ y,
                         sveitarfelag == "Garðabær" ~ y + 0.005,
                         sveitarfelag == "Reykjavíkurborg" ~ y ,
                         TRUE ~ y)) |> 
    filter(ar >= plot_year)

p <- plot_dat |> 
    ggplot(aes(ar, eiginfjarhlutfall, col = sveitarfelag)) +
    geom_line() +
    geom_point() +
    geom_text(data = plot_dat |> group_by(sveitarfelag) |> filter(ar == max(ar)),
              aes(label = label, x = x, y = y), nudge_x = 0.1, hjust = 0, size = 4) +
    geom_rangeframe(col = "black") +
    scale_x_continuous(breaks = plot_year:2021, 
                       limits = c(plot_year, 2022.3)) +
    scale_y_continuous(breaks = c(range(plot_dat$eiginfjarhlutfall), 0.2, 0.3, 0.4, 0.5, 0.6, 0.7), 
                       labels = label_percent(accuract = 1)) +
    scale_colour_brewer(type = "qual", palette = "Dark2") +
    theme_tufte() +
    theme(legend.position = "none") +
    labs(x = NULL,
         y = NULL,
         title = "Eiginfjárhlutfall sveitarfélaga (A-hluti)",
         subtitle = "Eiginfjárhlutfall sýnir hlutfall fjármagns sem er í eigu sveitarfélagsins (restin eru skuldir)",
         caption = "Kóði og gögn: https://github.com/bgautijonsson/arsreikningar_sveitarfelaga")

p

ggsave(plot = p,
       filename = "eiginfjárhlutfall.png",
       width = 8, height = 0.5 * 8, scale = 1.3, bg = "white")
```

### Skuldahlutfall

```{r, fig.asp = 0.5, fig.width = 10, out.width = "100%"}
plot_dat <- d |> 
    group_by(sveitarfelag) |> 
    mutate(label = ifelse(ar == max(ar), sveitarfelag, NA_character_)) |> 
    ungroup() |> 
    mutate(skuldahlutf = 1 - eiginfjarhlutfall,
           x = ar,
           y = skuldahlutf,
           y = case_when(sveitarfelag == "Mosfellsbær" ~ y + 0,
                         sveitarfelag == "Kópavogsbær" ~ y,
                         sveitarfelag == "Garðabær" ~ y + 0.005,
                         sveitarfelag == "Reykjavíkurborg" ~ y ,
                         TRUE ~ y)) |> 
    filter(ar >= plot_year)

p <- plot_dat |> 
    ggplot(aes(ar, skuldahlutf, col = sveitarfelag)) +
    geom_line() +
    geom_point() +
    geom_text(data = plot_dat |> group_by(sveitarfelag) |> filter(ar == max(ar)),
              aes(label = label, x = x, y = y), nudge_x = 0.1, hjust = 0, size = 4) +
    geom_rangeframe(col = "black") +
    scale_x_continuous(breaks = plot_year:2021, 
                       limits = c(plot_year, 2022.3)) +
    scale_y_continuous(breaks = c(range(plot_dat$skuldahlutf), 0.2, 0.3, 0.4, 0.5, 0.6, 0.7), 
                       labels = label_percent(accuract = 1)) +
    scale_colour_brewer(type = "qual", palette = "Dark2") +
    theme_tufte() +
    theme(legend.position = "none") +
    labs(x = NULL,
         y = NULL,
         title = "Hlutfall skulda af heildareignum sveitarfélaga (A-hluti)",
         subtitle = "Hlutfallið sýnir hve stór hluti heildareigna er fjármagnaður með lánum",
         caption = "Kóði og gögn: https://github.com/bgautijonsson/arsreikningar_sveitarfelaga")

p

ggsave(plot = p,
       filename = "skuldahlutfall.png",
       width = 8, height = 0.5 * 8, scale = 1.3, bg = "white")
```

### Veltufjárhlutfall

```{r, fig.asp = 0.5, fig.width = 10, out.width = "100%"}
plot_dat <- d |> 
    group_by(sveitarfelag) |> 
    mutate(label = ifelse(ar == max(ar), sveitarfelag, NA_character_)) |> 
    ungroup() |> 
    mutate(x = ar,
           y = veltufjarhlutf,
           y = case_when(sveitarfelag == "Mosfellsbær" ~ y + 0.06,
                         sveitarfelag == "Kópavogsbær" ~ y - 0.03,
                         sveitarfelag == "Garðabær" ~ y + 0.03,
                         sveitarfelag == "Seltjarnarnesbær" ~ y + 0.03,
                         sveitarfelag == "Hafnarfjarðarkaupstaður" ~ y - 0.1,
                         TRUE ~ y)) |> 
    filter(ar >= plot_year)

p <- plot_dat |> 
    ggplot(aes(ar, veltufjarhlutf, col = sveitarfelag)) +
    geom_hline(yintercept = 1, lty = 2) +
    geom_line() +
    geom_point() +
    geom_text(data = plot_dat |> group_by(sveitarfelag) |> filter(ar == max(ar)),
              aes(label = label, x = x, y = y), nudge_x = 0.1, hjust = 0, size = 4) +
    geom_rangeframe(col = "black") +
    scale_x_continuous(breaks = plot_year:2021, 
                       limits = c(plot_year, 2023)) +
    scale_y_continuous(breaks = c(range(plot_dat$veltufjarhlutf), 1, 2, 3), 
                       labels = label_percent()) +
    scale_colour_brewer(type = "qual", palette = "Dark2") +
    theme_tufte() +
    theme(legend.position = "none") +
    labs(x = NULL,
         y = NULL,
         title = "Veltufjármunir sveitarfélaga sem hlutfall af skammtímaskuldum (A-hluti)",
         subtitle = "Veltufjárhlutfall er hlutfall skammtímaskulda deilt upp í eignir sem er hægt að nota í að borga í skammtímaskuldir",
         caption = "Kóði og gögn: https://github.com/bgautijonsson/arsreikningar_sveitarfelaga")

p

ggsave(plot = p,
       filename = "veltufjarhlutfall.png",
       width = 8, height = 0.5 * 8, scale = 1.3, bg = "white")
```

### Rekstrarniðurstaða


#### Hlutfall af árstekjum

```{r, fig.asp = 0.5, fig.width = 10, out.width = "100%"}
plot_dat <- d |> 
    group_by(sveitarfelag) |> 
    mutate(label = ifelse(ar == max(ar), sveitarfelag, NA_character_)) |> 
    ungroup() |> 
    mutate(x = ar,
           y = rekstrarnidurstada_hlutf,
           y = case_when(sveitarfelag == "Mosfellsbær" ~ y - 0.005,
                         sveitarfelag == "Kópavogsbær" ~ y + 0.005,
                         sveitarfelag == "Garðabær" ~ y - 0.003,
                         sveitarfelag == "Seltjarnarnesbær" ~ y,
                         sveitarfelag == "Hafnarfjarðarkaupstaður" ~ y + 0.005,
                         sveitarfelag == "Reykjavíkurborg" ~ y,
                         TRUE ~ y)) |> 
    filter(ar >= plot_year)

p <- plot_dat |> 
    ggplot(aes(ar, rekstrarnidurstada_hlutf, col = sveitarfelag)) +
    geom_hline(yintercept = 0, lty = 2) +
    geom_line() +
    geom_point() +
    geom_text(data = plot_dat |> group_by(sveitarfelag) |> filter(ar == max(ar)),
              aes(label = label, x = x, y = y), nudge_x = 0.1, hjust = 0, size = 4) +
    geom_rangeframe(col = "black") +
    scale_x_continuous(breaks = plot_year:2021, 
                       limits = c(plot_year, 2022.4)) +
    scale_y_continuous(breaks = c(range(plot_dat$rekstrarnidurstada_hlutf), 0, -0.05, 0.05, -0.1, 0.1), 
                       labels = label_percent()) +
    scale_colour_brewer(type = "qual", palette = "Dark2") +
    theme_tufte() +
    theme(legend.position = "none") +
    labs(x = NULL,
         y = NULL,
         title = "Rekstrarniðurstaða sveitarfélaga sem hlutfall af tekjum (A-hluti)",
         caption = "Kóði og gögn: https://github.com/bgautijonsson/arsreikningar_sveitarfelaga")

p

ggsave(plot = p,
       filename = "rekstur_hlutf_tekjur.png",
       width = 8, height = 0.5 * 8, scale = 1.3, bg = "white")
```

#### Per íbúi

```{r, fig.asp = 0.5, fig.width = 10, out.width = "100%"}
plot_dat <- d |> 
    mutate(rekstur_per_ibui = rekstrarnidurstada / mannfjoldi) |> 
    group_by(sveitarfelag) |> 
    mutate(label = ifelse(ar == max(ar), sveitarfelag, NA_character_)) |> 
    ungroup() |> 
    mutate(x = ar,
           y = rekstur_per_ibui,
           y = case_when(sveitarfelag == "Mosfellsbær" ~ y - 3.3e3,
                         sveitarfelag == "Kópavogsbær" ~ y + 4e3,
                         sveitarfelag == "Garðabær" ~ y - 1e3,
                         sveitarfelag == "Seltjarnarnesbær" ~ y,
                         sveitarfelag == "Hafnarfjarðarkaupstaður" ~ y + 3.3e3,
                         sveitarfelag == "Reykjavíkurborg" ~ y,
                         TRUE ~ y)) |> 
    filter(ar >= plot_year)

p <- plot_dat |> 
    ggplot(aes(ar, rekstur_per_ibui, col = sveitarfelag)) +
    geom_hline(yintercept = 0, lty = 2) +
    geom_line() +
    geom_point() +
    geom_text(data = plot_dat |> group_by(sveitarfelag) |> filter(ar == max(ar)),
              aes(label = label, x = x, y = y), nudge_x = 0.1, hjust = 0, size = 4) +
    geom_rangeframe(col = "black") +
    scale_x_continuous(breaks = plot_year:2021, 
                       limits = c(plot_year, 2022.4)) +
    scale_y_continuous(breaks = c(range(plot_dat$rekstur_per_ibui), -5e4, 5e4, 1e5), 
                       labels = label_number()) +
    scale_colour_brewer(type = "qual", palette = "Dark2") +
    theme_tufte() +
    theme(legend.position = "none") +
    labs(x = NULL,
         y = NULL,
         title = "Rekstrarniðurstaða sveitarfélaga per íbúi (A-hluti)",
         caption = "Kóði og gögn: https://github.com/bgautijonsson/arsreikningar_sveitarfelaga")

p

ggsave(plot = p,
       filename = "rekstur_per_ibui.png",
       width = 8, height = 0.5 * 8, scale = 1.3, bg = "white")
```

#### Yfir allt kjörtímabilið (hlutf tekjum)

```{r, fig.asp = 0.5, fig.width = 10, out.width = "100%"}
plot_dat <- d |> 
    filter(ar >= 2018) |> 
    group_by(sveitarfelag) |> 
    summarise(rekstrarnidurstada = sum(rekstrarnidurstada),
              tekjur = sum(tekjur),
              rekstrarnidurstada_hlutf = rekstrarnidurstada / tekjur,
              .groups = "drop") |> 
    mutate(sveitarfelag1 = fct_reorder(sveitarfelag, rekstrarnidurstada_hlutf))


p <- plot_dat |> 
    ggplot(aes(sveitarfelag1, rekstrarnidurstada_hlutf)) +
    geom_hline(yintercept = 0, lty = 2, alpha = 0.5) +
    geom_col(aes(fill = sveitarfelag)) +
    geom_rangeframe() +
    scale_y_continuous(labels = label_percent(),
                       breaks = c(-5.7, -0.7, 0, 2.5, 4.9, 0)/100) +
    scale_fill_brewer(type = "qual", palette = "Dark2") +
    theme_tufte() +
    theme(legend.position = "none",
          axis.text.x = element_text(angle = 30, hjust = 1, vjust = 1)) +
    labs(x = NULL,
         y = NULL,
         title = "Samanlögð rekstrarniðurstaða sveitarfélaga sem hlutfall af tekjum yfir kjörtímabilið (A-hluti)",
         caption = "Kóði og gögn: https://github.com/bgautijonsson/arsreikningar_sveitarfelaga")

p

ggsave(plot = p,
       filename = "rekstur_kjortimabil_hlutf_tekjum.png",
       width = 8, height = 0.5 * 8, scale = 1.3, bg = "white")
```

#### Yfir allt kjörtímabilið (per íbúi)

```{r, fig.asp = 0.5, fig.width = 10, out.width = "100%"}
plot_dat <- d |> 
    filter(ar >= 2018) |> 
    group_by(sveitarfelag) |> 
    summarise(rekstrarnidurstada = sum(rekstrarnidurstada),
              mannfjoldi = mean(mannfjoldi),
              rekstrarnidurstada_hlutf = rekstrarnidurstada / mannfjoldi,
              .groups = "drop") |> 
    mutate(sveitarfelag1 = fct_reorder(sveitarfelag, rekstrarnidurstada_hlutf))


p <- plot_dat |> 
    ggplot(aes(sveitarfelag1, rekstrarnidurstada_hlutf)) +
    geom_hline(yintercept = 0, lty = 2, alpha = 0.5) +
    geom_col(aes(fill = sveitarfelag)) +
    geom_rangeframe() +
    scale_y_continuous(labels = label_number(suffix = " kr"),
                       breaks = c(-157502, -28343, 91633, 106794, 176438)) +
    scale_fill_brewer(type = "qual", palette = "Dark2") +
    theme_tufte() +
    theme(legend.position = "none",
          axis.text.x = element_text(angle = 30, hjust = 1, vjust = 1)) +
    labs(x = NULL,
         y = NULL,
         title = "Samanlögð rekstrarniðurstaða sveitarfélaga per íbúi yfir kjörtímabilið (A-hluti)",
         caption = "Kóði og gögn: https://github.com/bgautijonsson/arsreikningar_sveitarfelaga")

p

ggsave(plot = p,
       filename = "rekstur_kjortimabil_per_ibui.png",
       width = 8, height = 0.5 * 8, scale = 1.3, bg = "white")
```

#### Frá 2010 (hlutf tekjum)

```{r, fig.asp = 0.5, fig.width = 10, out.width = "100%"}
plot_dat <- d |> 
    filter(ar >= 2010) |> 
    group_by(sveitarfelag) |> 
    summarise(rekstrarnidurstada = sum(rekstrarnidurstada),
              tekjur = sum(tekjur),
              rekstrarnidurstada_hlutf = rekstrarnidurstada / tekjur,
              .groups = "drop") |> 
    mutate(sveitarfelag1 = fct_reorder(sveitarfelag, rekstrarnidurstada_hlutf))


p <- plot_dat |> 
    ggplot(aes(sveitarfelag1, rekstrarnidurstada_hlutf)) +
    geom_hline(yintercept = 0, lty = 2, alpha = 0.5) +
    geom_col(aes(fill = sveitarfelag)) +
    geom_rangeframe() +
    scale_y_continuous(labels = label_percent(accuracy = 0.1),
                       breaks = c(plot_dat$rekstrarnidurstada_hlutf)) +
    scale_fill_brewer(type = "qual", palette = "Dark2") +
    theme_tufte() +
    theme(legend.position = "none",
          axis.text.x = element_text(angle = 30, hjust = 1, vjust = 1)) +
    labs(x = NULL,
         y = NULL,
         title = "Samanlögð rekstrarniðurstaða sveitarfélaga sem hlutfall af tekjum frá 2010 (A-hluti)",
         caption = "Kóði og gögn: https://github.com/bgautijonsson/arsreikningar_sveitarfelaga")

p

ggsave(plot = p,
       filename = "rekstur_2010_hlutf_tekjum.png",
       width = 8, height = 0.5 * 8, scale = 1.3, bg = "white")
```

#### Frá 2010 (per íbúi)

```{r, fig.asp = 0.5, fig.width = 10, out.width = "100%"}
plot_dat <- d |> 
    filter(ar >= 2010) |> 
    group_by(sveitarfelag) |> 
    summarise(rekstrarnidurstada = sum(rekstrarnidurstada),
              mannfjoldi = mean(mannfjoldi),
              rekstrarnidurstada_hlutf = rekstrarnidurstada / mannfjoldi,
              .groups = "drop") |> 
    mutate(sveitarfelag1 = fct_reorder(sveitarfelag, rekstrarnidurstada_hlutf))


p <- plot_dat |> 
    ggplot(aes(sveitarfelag1, rekstrarnidurstada_hlutf)) +
    geom_hline(yintercept = 0, lty = 2, alpha = 0.5) +
    geom_col(aes(fill = sveitarfelag)) +
    geom_rangeframe() +
    scale_y_continuous(labels = label_number(suffix = " kr"),
                       breaks = c(plot_dat$rekstrarnidurstada_hlutf)) +
    scale_fill_brewer(type = "qual", palette = "Dark2") +
    theme_tufte() +
    theme(legend.position = "none",
          axis.text.x = element_text(angle = 30, hjust = 1, vjust = 1)) +
    labs(x = NULL,
         y = NULL,
         title = "Samanlögð rekstrarniðurstaða sveitarfélaga per íbúi frá 2010 (A-hluti)",
         caption = "Kóði og gögn: https://github.com/bgautijonsson/arsreikningar_sveitarfelaga")

p

ggsave(plot = p,
       filename = "rekstur_2010_per_ibui.png",
       width = 8, height = 0.5 * 8, scale = 1.3, bg = "white")
```

### EBITDA

#### Hlutfall af árstekjum

```{r, fig.asp = 0.5, fig.width = 10, out.width = "100%"}
plot_dat <- d |> 
    group_by(sveitarfelag) |> 
    mutate(label = ifelse(ar == max(ar), sveitarfelag, NA_character_)) |> 
    ungroup() |> 
    mutate(x = ar,
           y = ebitda_hlutf,
           y = case_when(sveitarfelag == "Mosfellsbær" ~ y,
                         sveitarfelag == "Kópavogsbær" ~ y,
                         sveitarfelag == "Garðabær" ~ y,
                         sveitarfelag == "Seltjarnarnesbær" ~ y,
                         sveitarfelag == "Hafnarfjarðarkaupstaður" ~ y + 0.005,
                         sveitarfelag == "Reykjavíkurborg" ~ y - 0.004,
                         TRUE ~ y)) |> 
    filter(ar >= plot_year)

p <- plot_dat |> 
    ggplot(aes(ar, ebitda_hlutf, col = sveitarfelag)) +
    geom_hline(yintercept = 0, lty = 2) +
    geom_line() +
    geom_point() +
    geom_text(data = plot_dat |> group_by(sveitarfelag) |> filter(ar == max(ar)),
              aes(label = label, x = x, y = y), nudge_x = 0.1, hjust = 0, size = 4) +
    geom_rangeframe(col = "black") +
    scale_x_continuous(breaks = plot_year:2021, 
                       limits = c(plot_year, 2022.4)) +
    scale_y_continuous(breaks = c(range(plot_dat$ebitda_hlutf), 0, 0.1, 0.2, 0.3), 
                       labels = label_percent()) +
    scale_colour_brewer(type = "qual", palette = "Dark2") +
    theme_tufte() +
    theme(legend.position = "none") +
    labs(x = NULL,
         y = NULL,
         title = "EBITDA sveitarfélaga sem hlutfall af tekjum (A-hluti)",
         subtitle = "EBITDA er rekstrarniðurstaða áður en tekið er tillit til vaxtagreiðslna og vaxtatekna, skattgreiðslna og afskrifta",
         caption = "Kóði og gögn: https://github.com/bgautijonsson/arsreikningar_sveitarfelaga")

p

ggsave(plot = p,
       filename = "ebitda_hlutf_tekjur.png",
       width = 8, height = 0.5 * 8, scale = 1.3, bg = "white")
```

#### Yfir allt kjörtímabilið (hlutf tekjum)

```{r, fig.asp = 0.5, fig.width = 10, out.width = "100%"}
plot_dat <- d |> 
    filter(ar >= 2018) |> 
    group_by(sveitarfelag) |> 
    summarise(ebitda = sum(ebitda),
              tekjur = sum(tekjur),
              ebitda_hlutf = ebitda / tekjur,
              .groups = "drop") |> 
    mutate(sveitarfelag1 = fct_reorder(sveitarfelag, ebitda_hlutf))


p <- plot_dat |> 
    ggplot(aes(sveitarfelag1, ebitda_hlutf)) +
    geom_hline(yintercept = 0, lty = 2, alpha = 0.5) +
    geom_col(aes(fill = sveitarfelag)) +
    geom_rangeframe() +
    scale_y_continuous(labels = label_percent(),
                       breaks = c(plot_dat$ebitda_hlutf)) +
    scale_fill_brewer(type = "qual", palette = "Dark2") +
    theme_tufte() +
    theme(legend.position = "none",
          axis.text.x = element_text(angle = 30, hjust = 1, vjust = 1)) +
    labs(x = NULL,
         y = NULL,
         title = "EBITDA sveitarfélaga sem hlutfall af tekjum yfir kjörtímabilið (A-hluti)",
         subtitle = "EBITDA er rekstrarniðurstaða áður en tekið er tillit til vaxtagreiðslna og vaxtatekna, skattgreiðslna og afskrifta",
         caption = "Kóði og gögn: https://github.com/bgautijonsson/arsreikningar_sveitarfelaga")

p

ggsave(plot = p,
       filename = "ebitda_kjortimabil_hlutf_tekjum.png",
       width = 8, height = 0.5 * 8, scale = 1.3, bg = "white")
```

#### Yfir allt kjörtímabilið (per íbúi)

```{r, fig.asp = 0.5, fig.width = 10, out.width = "100%"}
plot_dat <- d |> 
    filter(ar >= 2018) |> 
    group_by(sveitarfelag) |> 
    summarise(ebitda = sum(ebitda),
              mannfjoldi = mean(mannfjoldi),
              ebitda_hlutf = ebitda / mannfjoldi,
              .groups = "drop") |> 
    mutate(sveitarfelag1 = fct_reorder(sveitarfelag, ebitda_hlutf))


p <- plot_dat |> 
    ggplot(aes(sveitarfelag1, ebitda_hlutf)) +
    geom_hline(yintercept = 0, lty = 2, alpha = 0.5) +
    geom_col(aes(fill = sveitarfelag)) +
    geom_rangeframe() +
    scale_y_continuous(labels = label_number(suffix = " kr"),
                       breaks = c(plot_dat$ebitda_hlutf)) +
    scale_fill_brewer(type = "qual", palette = "Dark2") +
    theme_tufte() +
    theme(legend.position = "none",
          axis.text.x = element_text(angle = 30, hjust = 1, vjust = 1)) +
    labs(x = NULL,
         y = NULL,
         title = "EBITDA sveitarfélaga per íbúi yfir kjörtímabilið (A-hluti)",
         subtitle = "EBITDA er rekstrarniðurstaða áður en tekið er tillit til vaxtagreiðslna og vaxtatekna, skattgreiðslna og afskrifta",
         caption = "Kóði og gögn: https://github.com/bgautijonsson/arsreikningar_sveitarfelaga")

p

ggsave(plot = p,
       filename = "ebitda_kjortimabil_per_ibui.png",
       width = 8, height = 0.5 * 8, scale = 1.3, bg = "white")
```

### Veltufé frá rekstri

#### Hreint

```{r, fig.asp = 0.5, fig.width = 10, out.width = "100%"}
plot_dat <- d |> 
    group_by(sveitarfelag) |> 
    mutate(label = ifelse(ar == max(ar), sveitarfelag, NA_character_)) |> 
    ungroup() |> 
    mutate(x = ar,
           y = veltufe,
           y = case_when(sveitarfelag == "Mosfellsbær" ~ y - 0.005,
                         sveitarfelag == "Kópavogsbær" ~ y + 0.005,
                         sveitarfelag == "Garðabær" ~ y - 0.003,
                         sveitarfelag == "Seltjarnarnesbær" ~ y,
                         sveitarfelag == "Hafnarfjarðarkaupstaður" ~ y - 2e8,
                         sveitarfelag == "Reykjavíkurborg" ~ y,
                         TRUE ~ y)) |> 
    filter(ar >= plot_year)

p <- plot_dat |> 
    ggplot(aes(ar, veltufe, col = sveitarfelag)) +
    geom_hline(yintercept = 0, lty = 2) +
    geom_line() +
    geom_point() +
    geom_text(data = plot_dat |> group_by(sveitarfelag) |> filter(ar == max(ar)),
              aes(label = label, x = x, y = y), nudge_x = 0.1, hjust = 0, size = 4) +
    geom_rangeframe(col = "black") +
    scale_x_continuous(breaks = plot_year:2021, 
                       limits = c(plot_year, 2022.4)) +
    scale_y_continuous(breaks = c(range(plot_dat$veltufe), 5e9, 1e10), 
                       labels = label_number()) +
    scale_colour_brewer(type = "qual", palette = "Dark2") +
    theme_tufte() +
    theme(legend.position = "none") +
    labs(x = NULL,
         y = NULL,
         title = "Veltufé frá rekstri (A-hluti)",
         caption = "Kóði og gögn: https://github.com/bgautijonsson/arsreikningar_sveitarfelaga")

p

ggsave(plot = p,
       filename = "veltufe_fra_rekstri.png",
       width = 8, height = 0.5 * 8, scale = 1.3, bg = "white")
```

#### Hlutfall af árstekjum

```{r, fig.asp = 0.5, fig.width = 10, out.width = "100%"}
plot_dat <- d |> 
    mutate(hlutf = veltufe / tekjur) |> 
    group_by(sveitarfelag) |> 
    mutate(label = ifelse(ar == max(ar), sveitarfelag, NA_character_)) |> 
    ungroup() |> 
    mutate(x = ar,
           y = hlutf,
           y = case_when(sveitarfelag == "Mosfellsbær" ~ y,
                         sveitarfelag == "Kópavogsbær" ~ y,
                         sveitarfelag == "Garðabær" ~ y ,
                         sveitarfelag == "Seltjarnarnesbær" ~ y,
                         sveitarfelag == "Hafnarfjarðarkaupstaður" ~ y - 0.005,
                         sveitarfelag == "Reykjavíkurborg" ~ y + 0.005,
                         TRUE ~ y)) |> 
    filter(ar >= plot_year)

p <- plot_dat |> 
    ggplot(aes(ar, hlutf, col = sveitarfelag)) +
    geom_hline(yintercept = c(0), lty = 2) +
    geom_line() +
    geom_point() +
    geom_text(data = plot_dat |> group_by(sveitarfelag) |> filter(ar == max(ar)),
              aes(label = label, x = x, y = y), nudge_x = 0.1, hjust = 0, size = 4) +
    geom_rangeframe(col = "black") +
    scale_x_continuous(breaks = plot_year:2021, 
                       limits = c(plot_year, 2022.4)) +
    scale_y_continuous(breaks = c(range(plot_dat$hlutf), 0.05, 0.1, 0.15), 
                       labels = label_percent()) +
    scale_colour_brewer(type = "qual", palette = "Dark2") +
    theme_tufte() +
    theme(legend.position = "none") +
    labs(x = NULL,
         y = NULL,
         title = "Veltufé frá rekstri sem hlutfall af árstekjum",
         caption = "Kóði og gögn: https://github.com/bgautijonsson/arsreikningar_sveitarfelaga")

p

ggsave(plot = p,
       filename = "veltufe_fra_rekstri_hlutf_arstekjur.png",
       width = 8, height = 0.5 * 8, scale = 1.3, bg = "white")
```


### Viðmið eftirlitsnefndar

```{r, fig.asp = 0.5, fig.width = 10, out.width = "100%"}

plot_dat <- d |> 
    filter(ar >= 2010) |> 
    select(sveitarfelag, ar, 
           nettoskuldir_obs = nettoskuldir_hlutf_tekjur, 
           rekstrarnidurstada_obs = rekstrarnidurstada_hlutf, 
           framlegd_obs = framlegd_hlutf, 
           veltufe_obs = veltufe_hlutf_tekjur,
           veltufjarhlutfall_obs = veltufjarhlutfall) |> 
    mutate(framlegd_vidmid = nettoskuldir_obs/10,
           veltufe_vidmid = nettoskuldir_obs/20,
           rekstrarnidurstada_vidmid = 0,
           veltufjarhlutfall_vidmid = 1,
           nettoskuldir_vidmid = 1,
           ) |> 
    pivot_longer(c(-sveitarfelag, -ar), names_to = c("name", "type"), values_to = "value", names_sep = "_") |> 
    pivot_wider(names_from = type, values_from  = value) |> 
    mutate(diff = obs - vidmid,
           colour = obs >= vidmid,
           name = fct_recode(name,
                             "Framlegðarhlutfall" = "framlegd",
                             "Rekstrarniðurstaða" = "rekstrarnidurstada",
                             "Veltufé frá rekstri\n(hlutfall af tekjum)" = "veltufe",
                             "Nettóskuldahlutfall" = "nettoskuldir",
                             "Veltufjárhlutfall" = "veltufjarhlutfall") |> 
               fct_relevel("Nettóskuldahlutfall"),
           sveitarfelag = fct_recode(sveitarfelag,
                                     "Seltjarnarnesbær\n(til 2020)"= "Seltjarnarnesbær")) 


p <- plot_dat |> 
    filter(name != "Nettóskuldahlutfall") |> 
    ggplot() +
    geom_line(aes(ar, vidmid), lty = 2) +
    geom_point(aes(ar, obs, col = colour)) +
    # geom_line(data = plot_dat |> filter(name == "Nettóskuldahlutfall"), 
    #           aes(ar, vidmid), lty = 2, inherit.aes = FALSE, col = "black") +
    geom_point(data = plot_dat |> filter(name == "Nettóskuldahlutfall"),
               aes(ar, obs), inherit.aes = FALSE, col = "black") + 
    scale_x_continuous(breaks = c(2021, 2018, 2014)) +
    scale_y_continuous(labels = label_percent(),
                   breaks = pretty_breaks(4)) +
    scale_colour_brewer(type = "qual", palette = "Set1") +
    facet_grid(name ~ sveitarfelag, scales = "free_y") +
    theme_half_open() +
    theme(legend.position = "none", 
          panel.spacing.y = unit(0.04, units= "npc")) +
    labs(x = NULL,
         y = NULL,
         title = "Hvernig gengur sveitarfélögum að standast viðmið Eftirlitsnefndar með fjármálum sveitarfélaga (A-hluti)?",
         subtitle = "Brotin lína er viðmið og er reiknuð út frá nettóskuldum sem hlutfall af tekjum")


p

ggsave(plot = p,
       filename = "vidmid_eftirlitsnefndar.png",
       width = 8, height = 0.7 * 8, scale = 2, bg = "white")
```



## A og B hluti



```{r}
d <- efnahagur |> 
    select(-tegund3) |> 
    pivot_wider(names_from = tegund2, values_from = total) |> 
    inner_join(
        rekstur |> 
            pivot_wider(names_from = tegund2, values_from = total),
        by = c("ar", "sveitarfelag", "hluti")
    ) |> 
    inner_join(
        sjodsstreymi |> 
            pivot_wider(names_from = tegund2, values_from = total),
        by = c("ar", "sveitarfelag", "hluti")
    ) |> 
    mutate(heildarskuldir = `Skuldbindingar` + `Langtímaskuldir` + `Skammtímaskuldir`,
           eignir = `Varanlegir rekstrarfjármunir` + `Áhættufjármunir og langtímakröfur` + `Veltufjármunir`) |> 
    select(ar, sveitarfelag, hluti, heildarskuldir, eignir, tekjur = "Tekjur", gjold = "Gjöld", afskriftir = "Afskriftir", fjarmagnslidir = "Fjármagnsliðir",
           eigid_fe = "Eigið fé", veltufjarmunir = "Veltufjármunir", skammtimakrofur_eigin_fyrirtaeki = "Skammtímakröfur á eigin fyrirtæki",
           skammtimaskuldir = "Skammtímaskuldir", 
           veltufe = "Veltufé frá rekstri") |> 
    bind_rows(
        gogn_2021
    ) |> 
    mutate_at(vars(heildarskuldir:veltufe), ~ .x * 1000) |> 
    inner_join(mannfjoldi,
               by = c("ar", "sveitarfelag")) |> 
    mutate(nettoskuldir = heildarskuldir - veltufjarmunir + skammtimakrofur_eigin_fyrirtaeki,
           skuldir_hlutf_tekjur = heildarskuldir / tekjur,
           nettoskuldir_hlutf_tekjur = nettoskuldir / tekjur,
           veltufjarhlutfall = veltufjarmunir / skammtimaskuldir,
           eignahlutf = eignir / heildarskuldir,
           rekstrarnidurstada = tekjur - gjold + fjarmagnslidir,
           rekstrarnidurstada_hlutf = rekstrarnidurstada / tekjur,
           framlegd = rekstrarnidurstada + afskriftir,
           framlegd_hlutf = framlegd / tekjur,
           eiginfjarhlutfall = eigid_fe / eignir,
           skuldahlutfall = 1 - eiginfjarhlutfall,
           skuldir_per_ibui = heildarskuldir / mannfjoldi,
           veltufe_hlutf_tekjur = veltufe / tekjur,
           hluti = fct_recode(hluti,
                              "A-hluti" = "A_hluti",
                              "A og B-hluti" = "A_og_B_hluti")) |> 
    filter(hluti == "A og B-hluti",
           sveitarfelag %in% efnahagur$sveitarfelag)

d |> write_csv("arsreikningagogn_aogbhluti.csv")
```

```{r}
plot_year <- 2002
```

### Skuldir

#### Skuldir sem hlutfall af árstekjum

```{r, fig.asp = 0.5, fig.width = 10, out.width = "100%"}
plot_dat <- d |> 
    group_by(sveitarfelag) |> 
    mutate(label = ifelse(ar == max(ar), sveitarfelag, NA_character_)) |> 
    ungroup() |> 
    mutate(x = ar,
           y = skuldahlutf,
           y = case_when(sveitarfelag == "Mosfellsbær" ~ y + 0,
                         sveitarfelag == "Kópavogsbær" ~ y + 0.015,
                         sveitarfelag == "Garðabær" ~ y - 0.035,
                         sveitarfelag == "Reykjavíkurborg" ~ y,
                         TRUE ~ y)) |> 
    filter(ar >= plot_year)

p <- plot_dat |> 
    ggplot(aes(ar, skuldahlutf, col = sveitarfelag)) +
    geom_hline(yintercept = 1, lty = 2) +
    geom_line() +
    geom_point() +
    geom_text(data = plot_dat |> group_by(sveitarfelag) |> filter(ar == max(ar)),
              aes(label = label, x = x, y = y), nudge_x = 0.1, hjust = 0, size = 4) +
    geom_rangeframe(col = "black") +
    scale_x_continuous(breaks = plot_year:2021, 
                       limits = c(plot_year, 2024.5)) +
    scale_y_continuous(breaks = c(range(plot_dat$skuldahlutf), 0.75, 1, 1.25, 1.5, 2, 2.5), 
                       labels = label_percent(accuract = 1)) +
    scale_colour_brewer(type = "qual", palette = "Dark2") +
    theme_tufte() +
    theme(legend.position = "none") +
    labs(x = NULL,
         y = NULL,
         title = "Skuldir sveitafélaga sem hlutfall af árstekjum (A og B-hluti)",
         caption = "Kóði og gögn: https://github.com/bgautijonsson/arsreikningar_sveitarfelaga")

p

ggsave(plot = p,
       filename = "skuldir_hlutfall_arstekjum_aogb.png",
       width = 8, height = 0.5 * 8, scale = 1.3, bg = "white")
```

#### Skuldir á íbúa

```{r, fig.asp = 0.5, fig.width = 10, out.width = "100%"}
plot_dat <- d |> 
    mutate(hlutf = heildarskuldir / mannfjoldi) |> 
    group_by(sveitarfelag) |> 
    mutate(label = ifelse(ar == max(ar), sveitarfelag, NA_character_)) |> 
    ungroup() |> 
    mutate(x = ar,
           y = hlutf,
           y = case_when(sveitarfelag == "Mosfellsbær" ~ y + 1e4,
                         sveitarfelag == "Kópavogsbær" ~ y + 5e3,
                         sveitarfelag == "Garðabær" ~ y - 3e4,
                         sveitarfelag == "Hafnarfjarðarkaupstaður" ~ y + 1e5,
                         sveitarfelag == "Reykjavíkurborg" ~ y - 3.5e4,
                         sveitarfelag == "Seltjarnarnesbær" ~ y + 3.5e4,
                         TRUE ~ y)) |> 
    filter(ar >= plot_year)

p <- plot_dat |> 
    ggplot(aes(ar, hlutf, col = sveitarfelag)) +
    geom_line() +
    geom_point() +
    geom_text(data = plot_dat |> group_by(sveitarfelag) |> filter(ar == max(ar)),
              aes(label = label, x = x, y = y), nudge_x = 0.1, hjust = 0, size = 4) +
    geom_rangeframe(col = "black") +
    scale_x_continuous(breaks = plot_year:2021, 
                       limits = c(plot_year, 2024.5)) +
    scale_y_log10(breaks = c(range(plot_dat$hlutf), 3e5, 5e5, 1e6, 2e6), 
                  labels = label_number(accuracy = 1, suffix = " kr.")) +
    scale_colour_brewer(type = "qual", palette = "Dark2") +
    theme_tufte() +
    theme(legend.position = "none") +
    labs(x = NULL,
         y = NULL,
         title = "Skuldir sveitafélaga á hvern íbúa (A og B-hluti)",
         subtitle = "Mynd er á lograkvarða svo fjarlægð milli 1, 10, 100 og 1000 á y-ás er sá sami",
         caption = "Kóði og gögn: https://github.com/bgautijonsson/arsreikningar_sveitarfelaga")

p

ggsave(plot = p,
       filename = "skuldir_a_ibua_aogb.png",
       width = 8, height = 0.5 * 8, scale = 1.3, bg = "white")
```

#### Heildarskuldir

```{r, fig.asp = 0.5, fig.width = 10, out.width = "100%"}
plot_dat <- d |> 
    group_by(sveitarfelag) |> 
    mutate(label = ifelse(ar == max(ar), sveitarfelag, NA_character_)) |> 
    ungroup() |> 
    mutate(x = ar,
           y = heildarskuldir,
           y = case_when(sveitarfelag == "Mosfellsbær" ~ y - 1e9,
                         sveitarfelag == "Kópavogsbær" ~ y - 4e9,
                         sveitarfelag == "Garðabær" ~ y,
                         sveitarfelag == "Reykjavíkurborg" ~ y,
                         sveitarfelag == "Hafnarfjarðarkaupstaður" ~ y + 6e9,
                         TRUE ~ y)) |> 
    filter(ar >= plot_year)

p <- plot_dat |> 
    ggplot(aes(ar, heildarskuldir, col = sveitarfelag)) +
    geom_line() +
    geom_point() +
    geom_text(data = plot_dat |> group_by(sveitarfelag) |> filter(ar == max(ar)),
              aes(label = label, x = x, y = y), nudge_x = 0.1, hjust = 0, size = 4) +
    geom_rangeframe(col = "black") +
    scale_x_continuous(breaks = plot_year:2021, 
                       limits = c(plot_year, 2024.5)) +
    scale_y_log10(breaks = c(range(plot_dat$heildarskuldir), 1e10, 3e10, 1e11, 3e11), 
                  labels = label_number(accuracy = 1, suffix = " kr.")) +
    scale_colour_brewer(type = "qual", palette = "Dark2") +
    theme_tufte() +
    theme(legend.position = "none") +
    labs(x = NULL,
         y = NULL,
         title = "Heildarskuldir sveitarfélaga (A og B-hluti)",
         subtitle = "Mynd er á lograkvarða svo fjarlægð milli 1, 10, 100 og 1000 á y-ás er sá sami",
         caption = "Kóði og gögn: https://github.com/bgautijonsson/arsreikningar_sveitarfelaga")


p

ggsave(plot = p,
       filename = "heildarskuldir_aogb.png",
       width = 8, height = 0.5 * 8, scale = 1.3, bg = "white")
```


### Aukning skulda

#### Frá 2018

```{r, fig.asp = 0.4, fig.width = 10, out.width = "100%"}
plot_dat <- d |> 
    group_by(sveitarfelag) |> 
    mutate(label = ifelse(ar == max(ar), sveitarfelag, NA_character_),
           skuldaaukning = heildarskuldir / heildarskuldir[ar == 2018]) |> 
    ungroup() |> 
    mutate(x = ar,
           y = skuldaaukning,
           y = case_when(sveitarfelag == "Mosfellsbær" ~ y + 0.01,
                         sveitarfelag == "Kópavogsbær" ~ y,
                         sveitarfelag == "Garðabær" ~ y - 0.01,
                         sveitarfelag == "Reykjavíkurborg" ~ y,
                         sveitarfelag == "Hafnarfjarðarkaupstaður" ~ y,
                         TRUE ~ y)) |> 
    filter(ar >= 2018)

p <- plot_dat |> 
    ggplot(aes(ar, skuldaaukning, col = sveitarfelag)) +
    geom_line() +
    geom_point() +
    geom_text(data = plot_dat |> group_by(sveitarfelag) |> filter(ar == max(ar)),
              aes(label = label, x = x, y = y), nudge_x = 0.02, hjust = 0, size = 4) +
    geom_rangeframe(col = "black") +
    scale_x_continuous(breaks = 2018:2021, 
                       limits = c(NA, 2021.55)) +
    scale_y_continuous(breaks = c(range(plot_dat$skuldaaukning), 1.25, 1.5), 
                       labels = label_number(suffix = "x")) +
    scale_colour_brewer(type = "qual", palette = "Dark2") +
    theme_tufte() +
    theme(legend.position = "none") +
    labs(x = NULL,
         y = NULL,
         title = "Hlutfallsleg aukning heildarskulda sveitarfélaga síðan 2018 (A og B-hluti)",
         caption = "Kóði og gögn: https://github.com/bgautijonsson/arsreikningar_sveitarfelaga")

p

ggsave(plot = p,
       filename = "skuldaaukning_aogb.png",
       width = 8, height = 0.5 * 8, scale = 1.3, bg = "white")
```

#### Frá 2010

```{r, fig.asp = 0.4, fig.width = 10, out.width = "100%"}
plot_dat <- d |> 
    group_by(sveitarfelag) |> 
    mutate(label = ifelse(ar == max(ar), sveitarfelag, NA_character_),
           skuldaaukning = heildarskuldir / heildarskuldir[ar == 2010]) |> 
    ungroup() |> 
    mutate(x = ar,
           y = skuldaaukning,
           y = case_when(sveitarfelag == "Mosfellsbær" ~ y ,
                         sveitarfelag == "Kópavogsbær" ~ y,
                         sveitarfelag == "Garðabær" ~ y,
                         sveitarfelag == "Reykjavíkurborg" ~ y - 0.04,
                         sveitarfelag == "Hafnarfjarðarkaupstaður" ~ y + 0.05,
                         TRUE ~ y)) |> 
    filter(ar >= 2010)

p <- plot_dat |> 
    ggplot(aes(ar, skuldaaukning, col = sveitarfelag)) +
    geom_line() +
    geom_point() +
    geom_text(data = plot_dat |> group_by(sveitarfelag) |> filter(ar == max(ar)),
              aes(label = label, x = x, y = y), nudge_x = 0.1, hjust = 0, size = 4) +
    geom_rangeframe(col = "black") +
    scale_x_continuous(breaks = 2010:2021, 
                       limits = c(NA, 2023.2)) +
    scale_y_continuous(breaks = c(range(plot_dat$skuldaaukning), 1, 1.25, 1.5, 2, 2.5, 3), 
                       labels = label_number(suffix = "x")) +
    scale_colour_brewer(type = "qual", palette = "Dark2") +
    theme_tufte() +
    theme(legend.position = "none") +
    labs(x = NULL,
         y = NULL,
         title = "Hlutfallsleg aukning heildarskulda sveitarfélaga síðan 2010 (A og B-hluti)",
         caption = "Kóði og gögn: https://github.com/bgautijonsson/arsreikningar_sveitarfelaga")

p

ggsave(plot = p,
       filename = "skuldaaukning_2010_aogb.png",
       width = 8, height = 0.5 * 8, scale = 1.3, bg = "white")
```





### Breyting frá 2010

#### Hlutfall af tekjum

```{r}
plot_dat <- d |> 
    filter(ar %in% c(2010, 2021) | (sveitarfelag == "Seltjarnarnesbær" & ar == 2020)) |> 
    group_by(sveitarfelag) |> 
    mutate(ar = ifelse(ar == max(ar), "eftir", "fyrir")) |> 
    ungroup() |> 
    mutate(skuldahlutf = heildarskuldir / tekjur) |> 
    select(ar, sveitarfelag, skuldahlutf) |> 
    pivot_wider(names_from = ar, values_from = skuldahlutf) |> 
    mutate(munur = eftir - fyrir,
           sveitarfelag1 = fct_reorder(sveitarfelag, munur))

p <- plot_dat |> 
    ggplot(aes(sveitarfelag1, munur)) +
    geom_hline(yintercept = 0, lty = 2, alpha = 0.5) +
    geom_col(aes(fill = sveitarfelag)) +
    geom_rangeframe() +
    scale_y_continuous(labels = label_percent(),
                       breaks = c(-128, -122, -44.5, -1.7, 31.2)/100) +
    scale_fill_brewer(type = "qual", palette = "Dark2") +
    theme_tufte() +
    theme(legend.position = "none",
          axis.text.x = element_text(angle = 30, hjust = 1, vjust = 1)) +
    labs(x = NULL,
         y = NULL,
         title = "Breyting í heildarskuldum sem hlutfall af tekjum frá 2010 - 2021 (A og B-hluti)",
         caption = "Kóði og gögn: https://github.com/bgautijonsson/arsreikningar_sveitarfelaga")

p

ggsave(plot = p,
       filename = "heildarskuldir_kjortimabil_hlutf_tekjur_aogb.png",
       width = 8, height = 0.5 * 8, scale = 1.3, bg = "white")
```

#### Á íbúa

```{r}
plot_dat <- d |> 
    filter(ar %in% c(2010, 2021) | (sveitarfelag == "Seltjarnarnesbær" & ar == 2020)) |> 
    group_by(sveitarfelag) |> 
    mutate(ar = ifelse(ar == max(ar), "eftir", "fyrir")) |> 
    ungroup() |> 
    mutate(skuldahlutf = heildarskuldir / mannfjoldi) |> 
    select(ar, sveitarfelag, skuldahlutf) |> 
    pivot_wider(names_from = ar, values_from = skuldahlutf) |> 
    mutate(munur = eftir - fyrir,
           sveitarfelag1 = fct_reorder(sveitarfelag, munur))

p <- plot_dat |> 
    ggplot(aes(sveitarfelag1, munur)) +
    geom_hline(yintercept = 0, lty = 2, alpha = 0.5) +
    geom_col(aes(fill = sveitarfelag)) +
    geom_rangeframe() +
    scale_y_continuous(labels = label_number(suffix = " kr"),
                       breaks = c(plot_dat$munur)) +
    scale_fill_brewer(type = "qual", palette = "Dark2") +
    theme_tufte() +
    theme(legend.position = "none",
          axis.text.x = element_text(angle = 30, hjust = 1, vjust = 1)) +
    labs(x = NULL,
         y = NULL,
         title = "Breyting í heildarskuldum per íbúi frá 2010 - 2021 (A og B-hluti)",
         caption = "Kóði og gögn: https://github.com/bgautijonsson/arsreikningar_sveitarfelaga")

p

ggsave(plot = p,
       filename = "heildarskuldir_kjortimabil_per_ibui_aogb.png",
       width = 8, height = 0.5 * 8, scale = 1.3, bg = "white")
```



### Nettó skuldir

#### Nettó skuldir sem hlutfall af árstekjum

```{r, fig.asp = 0.5, fig.width = 10, out.width = "100%"}
plot_dat <- d |> 
    group_by(sveitarfelag) |> 
    mutate(label = ifelse(ar == max(ar), sveitarfelag, NA_character_)) |> 
    ungroup() |> 
    mutate(x = ar,
           y = nettoskuldahlutf,
           y = case_when(sveitarfelag == "Mosfellsbær" ~ y + 0.04,
                         sveitarfelag == "Kópavogsbær" ~ y + 0.04,
                         sveitarfelag == "Garðabær" ~ y - 0.05,
                         sveitarfelag == "Reykjavíkurborg" ~ y,
                         sveitarfelag == "Hafnarfjarðarkaupstaður" ~ y + 0.04,
                         sveitarfelag == "Seltjarnarnes" ~ y + 0.07,
                         TRUE ~ y)) |> 
    filter(ar >= plot_year)

p <- plot_dat |> 
    ggplot(aes(ar, nettoskuldahlutf, col = sveitarfelag)) +
    geom_hline(yintercept = 1, lty = 2) +
    geom_line() +
    geom_point() +
    geom_text(data = plot_dat |> group_by(sveitarfelag) |> filter(ar == max(ar)),
              aes(label = label, x = x, y = y), nudge_x = 0.1, hjust = 0, size = 4) +
    geom_rangeframe(col = "black") +
    scale_x_continuous(breaks = plot_year:2021, 
                       limits = c(plot_year, 2024.5)) +
    scale_y_continuous(breaks = c(range(plot_dat$nettoskuldahlutf), 0.75, 1, 1.25, 1.5, 2, 2.5), 
                       labels = label_percent(accuract = 1)) +
    scale_colour_brewer(type = "qual", palette = "Dark2") +
    theme_tufte() +
    theme(legend.position = "none") +
    labs(x = NULL,
         y = NULL,
         title = "Nettóskuldir sveitafélaga sem hlutfall af árstekjum (A og B-hluti)",
         subtitle = "Nettóskuldir eru heildarskuldir að frádregnum peningalegum eignum án eigin fyrirtækja",
         caption = "Kóði og gögn: https://github.com/bgautijonsson/arsreikningar_sveitarfelaga")

p

ggsave(plot = p,
       filename = "nettoskuldir_hlutfall_arstekjum_aogb.png",
       width = 8, height = 0.5 * 8, scale = 1.3, bg = "white")
```

#### Nettó skuldir á íbúa

```{r, fig.asp = 0.5, fig.width = 10, out.width = "100%"}
plot_dat <- d |> 
    mutate(hlutf = nettoskuldir / mannfjoldi) |> 
    group_by(sveitarfelag) |> 
    mutate(label = ifelse(ar == max(ar), sveitarfelag, NA_character_)) |> 
    ungroup() |> 
    mutate(x = ar,
           y = hlutf,
           y = case_when(sveitarfelag == "Mosfellsbær" ~ y + 1e4,
                         sveitarfelag == "Kópavogsbær" ~ y + 5e3,
                         sveitarfelag == "Garðabær" ~ y - 1e4,
                         sveitarfelag == "Hafnarfjarðarkaupstaður" ~ y + 2e4,
                         sveitarfelag == "Reykjavíkurborg" ~ y,
                         sveitarfelag == "Seltjarnarnesbær" ~ y,
                         TRUE ~ y)) |> 
    filter(ar >= plot_year)

p <- plot_dat |> 
    ggplot(aes(ar, hlutf, col = sveitarfelag)) +
    geom_line() +
    geom_point() +
    geom_text(data = plot_dat |> group_by(sveitarfelag) |> filter(ar == max(ar)),
              aes(label = label, x = x, y = y), nudge_x = 0.1, hjust = 0, size = 4) +
    geom_rangeframe(col = "black") +
    scale_x_continuous(breaks = plot_year:2021, 
                       limits = c(plot_year, 2024.5)) +
    scale_y_continuous(breaks = c(range(plot_dat$hlutf), 3e5, 5e5, 1e6, 1.5e6, 2e6), 
                       labels = label_number(accuracy = 1, suffix = " kr.")) +
    scale_colour_brewer(type = "qual", palette = "Dark2") +
    theme_tufte() +
    theme(legend.position = "none") +
    labs(x = NULL,
         y = NULL,
         title = "Nettóskuldir sveitafélaga á hvern íbúa (A og B-hluti)",
         subtitle = "Nettóskuldir eru heildarskuldir að frádregnum peningalegum eignum án eigin fyrirtækja",
         caption = "Kóði og gögn: https://github.com/bgautijonsson/arsreikningar_sveitarfelaga")

p

ggsave(plot = p,
       filename = "nettoskuldir_a_ibua_aogb.png",
       width = 8, height = 0.5 * 8, scale = 1.3, bg = "white")
```

#### Aukning nettóskulda

##### Frá 2018

```{r, fig.asp = 0.4, fig.width = 10, out.width = "100%"}
plot_dat <- d |> 
    group_by(sveitarfelag) |> 
    mutate(label = ifelse(ar == max(ar), sveitarfelag, NA_character_),
           skuldaaukning = nettoskuldir / nettoskuldir[ar == 2018]) |> 
    ungroup() |> 
    mutate(x = ar,
           y = skuldaaukning,
           y = case_when(sveitarfelag == "Mosfellsbær" ~ y + 0.01,
                         sveitarfelag == "Kópavogsbær" ~ y,
                         sveitarfelag == "Garðabær" ~ y - 0.01,
                         sveitarfelag == "Reykjavíkurborg" ~ y,
                         sveitarfelag == "Hafnarfjarðarkaupstaður" ~ y,
                         TRUE ~ y)) |> 
    filter(ar >= 2018)

p <- plot_dat |> 
    ggplot(aes(ar, skuldaaukning, col = sveitarfelag)) +
    geom_hline(yintercept = 1, lty = 2, alpha = 0.6) +
    geom_line() +
    geom_point() +
    geom_text(data = plot_dat |> group_by(sveitarfelag) |> filter(ar == max(ar)),
              aes(label = label, x = x, y = y), nudge_x = 0.02, hjust = 0, size = 4) +
    geom_rangeframe(col = "black") +
    scale_x_continuous(breaks = 2018:2021, 
                       limits = c(NA, 2021.55)) +
    scale_y_continuous(breaks = c(range(plot_dat$skuldaaukning), 1.25, 1.5), 
                       labels = label_number(suffix = "x")) +
    scale_colour_brewer(type = "qual", palette = "Dark2") +
    theme_tufte() +
    theme(legend.position = "none") +
    labs(x = NULL,
         y = NULL,
         title = "Hlutfallsleg aukning nettóskulda sveitarfélaga síðan 2018 (A og B-hluti)",
         caption = "Kóði og gögn: https://github.com/bgautijonsson/arsreikningar_sveitarfelaga")

p

ggsave(plot = p,
       filename = "nettoskuldaaukning_aogb.png",
       width = 8, height = 0.5 * 8, scale = 1.3, bg = "white")
```

##### Frá 2010

```{r, fig.asp = 0.4, fig.width = 10, out.width = "100%"}
plot_dat <- d |> 
    group_by(sveitarfelag) |> 
    mutate(label = ifelse(ar == max(ar), sveitarfelag, NA_character_),
           skuldaaukning = nettoskuldir / nettoskuldir[ar == 2010]) |> 
    ungroup() |> 
    mutate(x = ar,
           y = skuldaaukning,
           y = case_when(sveitarfelag == "Mosfellsbær" ~ y ,
                         sveitarfelag == "Kópavogsbær" ~ y - 0.07,
                         sveitarfelag == "Garðabær" ~ y,
                         sveitarfelag == "Reykjavíkurborg" ~ y - 0.02,
                         sveitarfelag == "Hafnarfjarðarkaupstaður" ~ y + 0.05,
                         TRUE ~ y)) |> 
    filter(ar >= 2010)

p <- plot_dat |> 
    ggplot(aes(ar, skuldaaukning, col = sveitarfelag)) +
    geom_hline(yintercept = 1, lty = 2, alpha = 0.6) +
    geom_line() +
    geom_point() +
    geom_text(data = plot_dat |> group_by(sveitarfelag) |> filter(ar == max(ar)),
              aes(label = label, x = x, y = y), nudge_x = 0.1, hjust = 0, size = 4) +
    geom_rangeframe(col = "black") +
    scale_x_continuous(breaks = 2010:2021, 
                       limits = c(NA, 2023.2)) +
    scale_y_continuous(breaks = c(range(plot_dat$skuldaaukning), 1, 1.5, 3), 
                       labels = label_number(suffix = "x")) +
    scale_colour_brewer(type = "qual", palette = "Dark2") +
    theme_tufte() +
    theme(legend.position = "none") +
    labs(x = NULL,
         y = NULL,
         title = "Hlutfallsleg aukning nettóskulda sveitarfélaga síðan 2010 (A og B-hluti)",
         caption = "Kóði og gögn: https://github.com/bgautijonsson/arsreikningar_sveitarfelaga")

p

ggsave(plot = p,
       filename = "nettoskuldaaukning_2010_aogb.png",
       width = 8, height = 0.5 * 8, scale = 1.3, bg = "white")
```

```{r}
plot_year <- 2014
```

### Eiginfjárhlutfall

```{r, fig.asp = 0.5, fig.width = 10, out.width = "100%"}
plot_dat <- d |> 
    group_by(sveitarfelag) |> 
    mutate(label = ifelse(ar == max(ar), sveitarfelag, NA_character_)) |> 
    ungroup() |> 
    mutate(x = ar,
           y = eiginfjarhlutfall,
           y = case_when(sveitarfelag == "Mosfellsbær" ~ y + 0,
                         sveitarfelag == "Kópavogsbær" ~ y,
                         sveitarfelag == "Garðabær" ~ y - 0.003,
                         sveitarfelag == "Reykjavíkurborg" ~ y + 0.003,
                         TRUE ~ y)) |> 
    filter(ar >= plot_year)

p <- plot_dat |> 
    ggplot(aes(ar, eiginfjarhlutfall, col = sveitarfelag)) +
    geom_line() +
    geom_point() +
    geom_text(data = plot_dat |> group_by(sveitarfelag) |> filter(ar == max(ar)),
              aes(label = label, x = x, y = y), nudge_x = 0.1, hjust = 0, size = 4) +
    geom_rangeframe(col = "black") +
    scale_x_continuous(breaks = plot_year:2021, 
                       limits = c(plot_year, 2022.3)) +
    scale_y_continuous(breaks = c(range(plot_dat$eiginfjarhlutfall), 0.2, 0.3, 0.4, 0.5, 0.6, 0.7), 
                       labels = label_percent(accuract = 1)) +
    scale_colour_brewer(type = "qual", palette = "Dark2") +
    theme_tufte() +
    theme(legend.position = "none") +
    labs(x = NULL,
         y = NULL,
         title = "Eiginfjárhlutfall sveitarfélaga (A og B-hluti)",
         subtitle = "Eiginfjárhlutfall sýnir hlutfall fjármagns sem er í eigu sveitarfélagsins (restin eru skuldir)",
         caption = "Kóði og gögn: https://github.com/bgautijonsson/arsreikningar_sveitarfelaga")

p

ggsave(plot = p,
       filename = "eiginfjárhlutfall_aogb.png",
       width = 8, height = 0.5 * 8, scale = 1.3, bg = "white")
```

### Veltufjárhlutfall



```{r, fig.asp = 0.5, fig.width = 10, out.width = "100%"}
plot_dat <- d |> 
    group_by(sveitarfelag) |> 
    mutate(label = ifelse(ar == max(ar), sveitarfelag, NA_character_)) |> 
    ungroup() |> 
    mutate(x = ar,
           y = veltufjarhlutf,
           y = case_when(sveitarfelag == "Mosfellsbær" ~ y + 0.05,
                         sveitarfelag == "Kópavogsbær" ~ y + 0.01,
                         sveitarfelag == "Garðabær" ~ y - 0.04,
                         sveitarfelag == "Seltjarnarnesbær" ~ y + 0.09,
                         sveitarfelag == "Hafnarfjarðarkaupstaður" ~ y ,
                         TRUE ~ y)) |> 
    filter(ar >= plot_year)

p <- plot_dat |> 
    ggplot(aes(ar, veltufjarhlutf, col = sveitarfelag)) +
    geom_hline(yintercept = 1, lty = 2) +
    geom_line() +
    geom_point() +
    geom_text(data = plot_dat |> group_by(sveitarfelag) |> filter(ar == max(ar)),
              aes(label = label, x = x, y = y), nudge_x = 0.1, hjust = 0, size = 4) +
    geom_rangeframe(col = "black") +
    scale_x_continuous(breaks = plot_year:2021, 
                       limits = c(plot_year, 2022.3)) +
    scale_y_continuous(breaks = c(range(plot_dat$veltufjarhlutf), 1, 2, 3), 
                       labels = label_percent()) +
    scale_colour_brewer(type = "qual", palette = "Dark2") +
    theme_tufte() +
    theme(legend.position = "none") +
    coord_cartesian(ylim = c(0.23, 3)) +
    labs(x = NULL,
         y = NULL,
         title = "Veltufjárhlutfall sveitarfélaga (A og B-hluti)",
         subtitle = "Veltufjárhlutfall er hlutfall skammtímaskulda deilt upp í veltufjármuni (eignir sem er hægt að nota í að borga skammtímaskuldir)",
         caption = "Kóði og gögn: https://github.com/bgautijonsson/arsreikningar_sveitarfelaga")

p

ggsave(plot = p,
       filename = "veltufjarhlutfall_aogb.png",
       width = 8, height = 0.5 * 8, scale = 1.3, bg = "white")
```






### Rekstrarniðurstaða


#### Hlutfall af árstekjum

```{r, fig.asp = 0.5, fig.width = 10, out.width = "100%"}
plot_dat <- d |> 
    group_by(sveitarfelag) |> 
    mutate(label = ifelse(ar == max(ar), sveitarfelag, NA_character_)) |> 
    ungroup() |> 
    mutate(x = ar,
           y = rekstrarnidurstada_hlutf,
           y = case_when(sveitarfelag == "Mosfellsbær" ~ y - 0.005,
                         sveitarfelag == "Kópavogsbær" ~ y - 0.003,
                         sveitarfelag == "Garðabær" ~ y + 0.006,
                         sveitarfelag == "Seltjarnarnesbær" ~ y - 0.001,
                         sveitarfelag == "Hafnarfjarðarkaupstaður" ~ y + 0.008,
                         sveitarfelag == "Reykjavíkurborg" ~ y,
                         TRUE ~ y)) |> 
    filter(ar >= plot_year)

p <- plot_dat |> 
    ggplot(aes(ar, rekstrarnidurstada_hlutf, col = sveitarfelag)) +
    geom_hline(yintercept = 0, lty = 2) +
    geom_line() +
    geom_point() +
    geom_text(data = plot_dat |> group_by(sveitarfelag) |> filter(ar == max(ar)),
              aes(label = label, x = x, y = y), nudge_x = 0.1, hjust = 0, size = 4) +
    geom_rangeframe(col = "black") +
    scale_x_continuous(breaks = plot_year:2021, 
                       limits = c(plot_year, 2022.4)) +
    scale_y_continuous(breaks = c(range(plot_dat$rekstrarnidurstada_hlutf), 0, -0.05, 0.05, -0.1, 0.1, 0.2), 
                       labels = label_percent()) +
    scale_colour_brewer(type = "qual", palette = "Dark2") +
    theme_tufte() +
    theme(legend.position = "none") +
    labs(x = NULL,
         y = NULL,
         title = "Rekstrarniðurstaða sveitarfélaga sem hlutfall af tekjum (A og B-hluti)",
         caption = "Kóði og gögn: https://github.com/bgautijonsson/arsreikningar_sveitarfelaga")

p

ggsave(plot = p,
       filename = "rekstur_hlutf_tekjur_aogb.png",
       width = 8, height = 0.5 * 8, scale = 1.3, bg = "white")
```

#### Per íbúi

```{r, fig.asp = 0.5, fig.width = 10, out.width = "100%"}
plot_dat <- d |> 
    mutate(rekstur_per_ibui = rekstrarnidurstada / mannfjoldi) |> 
    group_by(sveitarfelag) |> 
    mutate(label = ifelse(ar == max(ar), sveitarfelag, NA_character_)) |> 
    ungroup() |> 
    mutate(x = ar,
           y = rekstur_per_ibui,
           y = case_when(sveitarfelag == "Mosfellsbær" ~ y,
                         sveitarfelag == "Kópavogsbær" ~ y,
                         sveitarfelag == "Garðabær" ~ y,
                         sveitarfelag == "Seltjarnarnesbær" ~ y - 5e3,
                         sveitarfelag == "Hafnarfjarðarkaupstaður" ~ y + 5e3,
                         sveitarfelag == "Reykjavíkurborg" ~ y,
                         TRUE ~ y)) |> 
    filter(ar >= plot_year)

p <- plot_dat |> 
    ggplot(aes(ar, rekstur_per_ibui, col = sveitarfelag)) +
    geom_hline(yintercept = 0, lty = 2) +
    geom_line() +
    geom_point() +
    geom_text(data = plot_dat |> group_by(sveitarfelag) |> filter(ar == max(ar)),
              aes(label = label, x = x, y = y), nudge_x = 0.1, hjust = 0, size = 4) +
    geom_rangeframe(col = "black") +
    scale_x_continuous(breaks = plot_year:2021, 
                       limits = c(plot_year, 2022.4)) +
    scale_y_continuous(breaks = c(range(plot_dat$rekstur_per_ibui), -5e4, 5e4, 1e5), 
                       labels = label_number()) +
    scale_colour_brewer(type = "qual", palette = "Dark2") +
    theme_tufte() +
    theme(legend.position = "none") +
    labs(x = NULL,
         y = NULL,
         title = "Rekstrarniðurstaða sveitarfélaga per íbúi (A og B-hluti)",
         caption = "Kóði og gögn: https://github.com/bgautijonsson/arsreikningar_sveitarfelaga")

p

ggsave(plot = p,
       filename = "rekstur_per_ibui_aogb.png",
       width = 8, height = 0.5 * 8, scale = 1.3, bg = "white")
```

#### Yfir allt kjörtímabilið (hlutf tekjum)

```{r, fig.asp = 0.5, fig.width = 10, out.width = "100%"}
plot_dat <- d |> 
    filter(ar >= 2018) |> 
    group_by(sveitarfelag) |> 
    summarise(rekstrarnidurstada = sum(rekstrarnidurstada),
              tekjur = sum(tekjur),
              rekstrarnidurstada_hlutf = rekstrarnidurstada / tekjur,
              .groups = "drop") |> 
    mutate(sveitarfelag1 = fct_reorder(sveitarfelag, rekstrarnidurstada_hlutf))


p <- plot_dat |> 
    ggplot(aes(sveitarfelag1, rekstrarnidurstada_hlutf)) +
    geom_hline(yintercept = 0, lty = 2, alpha = 0.5) +
    geom_col(aes(fill = sveitarfelag)) +
    geom_rangeframe() +
    scale_y_continuous(labels = label_percent(),
                       breaks = c(plot_dat$rekstrarnidurstada_hlutf, 8.36/100, 0)) +
    scale_fill_brewer(type = "qual", palette = "Dark2") +
    theme_tufte() +
    theme(legend.position = "none",
          axis.text.x = element_text(angle = 30, hjust = 1, vjust = 1)) +
    labs(x = NULL,
         y = NULL,
         title = "Samanlögð rekstrarniðurstaða sveitarfélaga sem hlutfall af tekjum yfir kjörtímabilið (A og B-hluti)",
         subtitle = "Rekstrarniðurstaða Reykjavíkurborgar væri +8,36% sé gildishækkun fasteigna 2021 ekki tekin með",
         caption = "Kóði og gögn: https://github.com/bgautijonsson/arsreikningar_sveitarfelaga")

p

ggsave(plot = p,
       filename = "rekstur_kjortimabil_hlutf_tekjum_aogb.png",
       width = 8, height = 0.5 * 8, scale = 1.3, bg = "white")
```

#### Yfir allt kjörtímabilið (per íbúi)

```{r, fig.asp = 0.5, fig.width = 10, out.width = "100%"}
plot_dat <- d |> 
    filter(ar >= 2018) |> 
    group_by(sveitarfelag) |> 
    summarise(rekstrarnidurstada = sum(rekstrarnidurstada),
              mannfjoldi = mean(mannfjoldi),
              rekstrarnidurstada_hlutf = rekstrarnidurstada / mannfjoldi,
              .groups = "drop") |> 
    mutate(sveitarfelag1 = fct_reorder(sveitarfelag, rekstrarnidurstada_hlutf))


p <- plot_dat |> 
    ggplot(aes(sveitarfelag1, rekstrarnidurstada_hlutf)) +
    geom_hline(yintercept = 0, lty = 2, alpha = 0.5) +
    geom_col(aes(fill = sveitarfelag)) +
    geom_rangeframe() +
    scale_y_continuous(labels = label_number(suffix = " kr"),
                       breaks = c(-25845, 168198, 220721, 247324, 488874, 642949, 0)) +
    scale_fill_brewer(type = "qual", palette = "Dark2") +
    theme_tufte() +
    theme(legend.position = "none",
          axis.text.x = element_text(angle = 30, hjust = 1, vjust = 1)) +
    labs(x = NULL,
         y = NULL,
         title = "Samanlögð rekstrarniðurstaða sveitarfélaga per íbúi yfir kjörtímabilið (A og B-hluti)",
         subtitle = "Rekstrarniðurstaða Reykjavíkurborgar væri +488.874 kr sé gildishækkun fasteigna 2021 ekki tekin með",
         caption = "Kóði og gögn: https://github.com/bgautijonsson/arsreikningar_sveitarfelaga")

p

ggsave(plot = p,
       filename = "rekstur_kjortimabil_per_ibui_aogb.png",
       width = 8, height = 0.5 * 8, scale = 1.3, bg = "white")
```

#### Frá 2010 (hlutf tekjum)

```{r, fig.asp = 0.5, fig.width = 10, out.width = "100%"}
plot_dat <- d |> 
    filter(ar >= 2010) |> 
    group_by(sveitarfelag) |> 
    summarise(rekstrarnidurstada = sum(rekstrarnidurstada),
              tekjur = sum(tekjur),
              rekstrarnidurstada_hlutf = rekstrarnidurstada / tekjur,
              .groups = "drop") |> 
    mutate(sveitarfelag1 = fct_reorder(sveitarfelag, rekstrarnidurstada_hlutf))


p <- plot_dat |> 
    ggplot(aes(sveitarfelag1, rekstrarnidurstada_hlutf)) +
    geom_hline(yintercept = 0, lty = 2, alpha = 0.5) +
    geom_col(aes(fill = sveitarfelag)) +
    geom_rangeframe() +
    scale_y_continuous(labels = label_percent(accuracy = 0.1),
                       breaks = c(plot_dat$rekstrarnidurstada_hlutf)) +
    scale_fill_brewer(type = "qual", palette = "Dark2") +
    theme_tufte() +
    theme(legend.position = "none",
          axis.text.x = element_text(angle = 30, hjust = 1, vjust = 1)) +
    labs(x = NULL,
         y = NULL,
         title = "Samanlögð rekstrarniðurstaða sveitarfélaga sem hlutfall af tekjum frá 2010 (A og B-hluti)",
         caption = "Kóði og gögn: https://github.com/bgautijonsson/arsreikningar_sveitarfelaga")

p

ggsave(plot = p,
       filename = "rekstur_2010_hlutf_tekjum_aogb.png",
       width = 8, height = 0.5 * 8, scale = 1.3, bg = "white")
```

#### Frá 2010 (per íbúi)

```{r, fig.asp = 0.5, fig.width = 10, out.width = "100%"}
plot_dat <- d |> 
    filter(ar >= 2010) |> 
    group_by(sveitarfelag) |> 
    summarise(rekstrarnidurstada = sum(rekstrarnidurstada),
              mannfjoldi = mean(mannfjoldi),
              rekstrarnidurstada_hlutf = rekstrarnidurstada / mannfjoldi,
              .groups = "drop") |> 
    mutate(sveitarfelag1 = fct_reorder(sveitarfelag, rekstrarnidurstada_hlutf))


p <- plot_dat |> 
    ggplot(aes(sveitarfelag1, rekstrarnidurstada_hlutf)) +
    geom_hline(yintercept = 0, lty = 2, alpha = 0.5) +
    geom_col(aes(fill = sveitarfelag)) +
    geom_rangeframe() +
    scale_y_continuous(labels = label_number(suffix = " kr"),
                       breaks = c(plot_dat$rekstrarnidurstada_hlutf)) +
    scale_fill_brewer(type = "qual", palette = "Dark2") +
    theme_tufte() +
    theme(legend.position = "none",
          axis.text.x = element_text(angle = 30, hjust = 1, vjust = 1)) +
    labs(x = NULL,
         y = NULL,
         title = "Samanlögð rekstrarniðurstaða sveitarfélaga per íbúi frá 2010 (A og B-hluti)",
         caption = "Kóði og gögn: https://github.com/bgautijonsson/arsreikningar_sveitarfelaga")

p

ggsave(plot = p,
       filename = "rekstur_2010_per_ibui_aogb.png",
       width = 8, height = 0.5 * 8, scale = 1.3, bg = "white")
```

### EBITDA

#### Hlutfall af árstekjum

```{r, fig.asp = 0.5, fig.width = 10, out.width = "100%"}
plot_dat <- d |> 
    group_by(sveitarfelag) |> 
    mutate(label = ifelse(ar == max(ar), sveitarfelag, NA_character_)) |> 
    ungroup() |> 
    mutate(x = ar,
           y = ebitda_hlutf,
           y = case_when(sveitarfelag == "Mosfellsbær" ~ y - 0.005,
                         sveitarfelag == "Kópavogsbær" ~ y,
                         sveitarfelag == "Garðabær" ~ y,
                         sveitarfelag == "Seltjarnarnesbær" ~ y,
                         sveitarfelag == "Hafnarfjarðarkaupstaður" ~ y + 0.005,
                         sveitarfelag == "Reykjavíkurborg" ~ y,
                         TRUE ~ y)) |> 
    filter(ar >= plot_year)

p <- plot_dat |> 
    ggplot(aes(ar, ebitda_hlutf, col = sveitarfelag)) +
    geom_hline(yintercept = 0, lty = 2) +
    geom_line() +
    geom_point() +
    geom_text(data = plot_dat |> group_by(sveitarfelag) |> filter(ar == max(ar)),
              aes(label = label, x = x, y = y), nudge_x = 0.1, hjust = 0, size = 4) +
    geom_rangeframe(col = "black") +
    scale_x_continuous(breaks = plot_year:2021, 
                       limits = c(plot_year, 2022.4)) +
    scale_y_continuous(breaks = c(range(plot_dat$ebitda_hlutf), 0,  -0.1, 0.1, 0.2, 0.3), 
                       labels = label_percent()) +
    scale_colour_brewer(type = "qual", palette = "Dark2") +
    theme_tufte() +
    theme(legend.position = "none") +
    labs(x = NULL,
         y = NULL,
         title = "EBITDA sveitarfélaga sem hlutfall af tekjum (A og B-hluti)",
         subtitle = "EBITDA er rekstrarniðurstaða áður en tekið er tillit til vaxtagreiðslna og vaxtatekna, skattgreiðslna og afskrifta",
         caption = "Kóði og gögn: https://github.com/bgautijonsson/arsreikningar_sveitarfelaga")

p

ggsave(plot = p,
       filename = "ebitda_hlutf_tekjur_aogb.png",
       width = 8, height = 0.5 * 8, scale = 1.3, bg = "white")
```

#### Per íbúi

```{r, fig.asp = 0.5, fig.width = 10, out.width = "100%"}
plot_dat <- d |> 
    mutate(ebitda_per_ibui = ebitda / mannfjoldi) |> 
    group_by(sveitarfelag) |> 
    mutate(label = ifelse(ar == max(ar), sveitarfelag, NA_character_)) |> 
    ungroup() |> 
    mutate(x = ar,
           y = ebitda_per_ibui,
           y = case_when(sveitarfelag == "Mosfellsbær" ~ y - 3.3e3,
                         sveitarfelag == "Kópavogsbær" ~ y + 4e3,
                         sveitarfelag == "Garðabær" ~ y - 1e3,
                         sveitarfelag == "Seltjarnarnesbær" ~ y,
                         sveitarfelag == "Hafnarfjarðarkaupstaður" ~ y + 3.3e3,
                         sveitarfelag == "Reykjavíkurborg" ~ y,
                         TRUE ~ y)) |> 
    filter(ar >= plot_year)

p <- plot_dat |> 
    ggplot(aes(ar, ebitda_per_ibui, col = sveitarfelag)) +
    geom_hline(yintercept = 0, lty = 2) +
    geom_line() +
    geom_point() +
    geom_text(data = plot_dat |> group_by(sveitarfelag) |> filter(ar == max(ar)),
              aes(label = label, x = x, y = y), nudge_x = 0.1, hjust = 0, size = 4) +
    geom_rangeframe(col = "black") +
    scale_x_continuous(breaks = plot_year:2021, 
                       limits = c(plot_year, 2022.4)) +
    scale_y_continuous(breaks = c(range(plot_dat$ebitda_per_ibui), 5e4, 1e5, 2e5, 3e5), 
                       labels = label_number()) +
    scale_colour_brewer(type = "qual", palette = "Dark2") +
    theme_tufte() +
    theme(legend.position = "none") +
    labs(x = NULL,
         y = NULL,
         title = "EBITDA sveitarfélaga per íbúi (A-hluti)",
         subtitle = "EBITDA er rekstrarniðurstaða áður en tekið er tillit til vaxtagreiðslna og vaxtatekna, skattgreiðslna og afskrifta",
         caption = "Kóði og gögn: https://github.com/bgautijonsson/arsreikningar_sveitarfelaga")

p

ggsave(plot = p,
       filename = "ebitda_per_ibui_aogb.png",
       width = 8, height = 0.5 * 8, scale = 1.3, bg = "white")
```

### Veltufé frá rekstri

#### Hlutfall af árstekjum

```{r, fig.asp = 0.5, fig.width = 10, out.width = "100%"}
plot_dat <- d |> 
    mutate(hlutf = veltufe / tekjur) |> 
    group_by(sveitarfelag) |> 
    mutate(label = ifelse(ar == max(ar), sveitarfelag, NA_character_)) |> 
    ungroup() |> 
    mutate(x = ar,
           y = hlutf,
           y = case_when(sveitarfelag == "Mosfellsbær" ~ y + 0.001,
                         sveitarfelag == "Kópavogsbær" ~ y,
                         sveitarfelag == "Garðabær" ~ y ,
                         sveitarfelag == "Seltjarnarnesbær" ~ y,
                         sveitarfelag == "Hafnarfjarðarkaupstaður" ~ y,
                         sveitarfelag == "Reykjavíkurborg" ~ y,
                         TRUE ~ y)) |> 
    filter(ar >= plot_year)

p <- plot_dat |> 
    ggplot(aes(ar, hlutf, col = sveitarfelag)) +
    geom_hline(yintercept = c(0), lty = 2) +
    geom_line() +
    geom_point() +
    geom_text(data = plot_dat |> group_by(sveitarfelag) |> filter(ar == max(ar)),
              aes(label = label, x = x, y = y), nudge_x = 0.1, hjust = 0, size = 4) +
    geom_rangeframe(col = "black") +
    scale_x_continuous(breaks = plot_year:2021, 
                       limits = c(plot_year, 2022.4)) +
    scale_y_continuous(breaks = c(range(plot_dat$hlutf), -0.05, 0, 0.05, 0.1, 0.15, 0.2, 0.25, 0.3), 
                       labels = label_percent()) +
    scale_colour_brewer(type = "qual", palette = "Dark2") +
    theme_tufte() +
    theme(legend.position = "none") +
    labs(x = NULL,
         y = NULL,
         title = "Veltufé frá rekstri sem hlutfall af árstekjum (A og B-hluti)",
         caption = "Kóði og gögn: https://github.com/bgautijonsson/arsreikningar_sveitarfelaga")

p

ggsave(plot = p,
       filename = "veltufe_fra_rekstri_hlutf_arstekjur_aogb.png",
       width = 8, height = 0.5 * 8, scale = 1.3, bg = "white")
```

### Viðmið eftirlitsnefndar

```{r, fig.asp = 0.5, fig.width = 10, out.width = "100%"}

plot_dat <- d |> 
    filter(ar >= 2010) |> 
    select(sveitarfelag, ar, 
           nettoskuldir_obs = nettoskuldir_hlutf_tekjur, 
           rekstrarnidurstada_obs = rekstrarnidurstada_hlutf, 
           framlegd_obs = framlegd_hlutf, 
           veltufe_obs = veltufe_hlutf_tekjur,
           veltufjarhlutfall_obs = veltufjarhlutfall) |> 
    mutate(framlegd_vidmid = nettoskuldir_obs/10,
           veltufe_vidmid = nettoskuldir_obs/20,
           rekstrarnidurstada_vidmid = 0,
           veltufjarhlutfall_vidmid = 1,
           nettoskuldir_vidmid = 1,
           ) |> 
    pivot_longer(c(-sveitarfelag, -ar), names_to = c("name", "type"), values_to = "value", names_sep = "_") |> 
    pivot_wider(names_from = type, values_from  = value) |> 
    mutate(diff = obs - vidmid,
           colour = obs >= vidmid,
           name = fct_recode(name,
                             "Framlegðarhlutfall" = "framlegd",
                             "Rekstrarniðurstaða" = "rekstrarnidurstada",
                             "Veltufé frá rekstri\n(hlutfall af tekjum)" = "veltufe",
                             "Nettóskuldahlutfall" = "nettoskuldir",
                             "Veltufjárhlutfall" = "veltufjarhlutfall") |> 
               fct_relevel("Nettóskuldahlutfall"),
           sveitarfelag = fct_recode(sveitarfelag,
                                     "Seltjarnarnesbær\n(til 2020)"= "Seltjarnarnesbær")) 


p <- plot_dat |> 
    filter(name != "Nettóskuldahlutfall") |> 
    ggplot() +
    geom_line(aes(ar, vidmid), lty = 2) +
    geom_point(aes(ar, obs, col = colour)) +
    # geom_line(data = plot_dat |> filter(name == "Nettóskuldahlutfall"), 
    #           aes(ar, vidmid), lty = 2, inherit.aes = FALSE, col = "black") +
    geom_point(data = plot_dat |> filter(name == "Nettóskuldahlutfall"),
               aes(ar, obs), inherit.aes = FALSE, col = "black") + 
    scale_x_continuous(breaks = c(2021, 2018, 2014)) +
    scale_y_continuous(labels = label_percent(),
                   breaks = pretty_breaks(4)) +
    scale_colour_brewer(type = "qual", palette = "Set1") +
    facet_grid(name ~ sveitarfelag, scales = "free_y") +
    theme_half_open() +
    theme(legend.position = "none", 
          panel.spacing.y = unit(0.04, units= "npc")) +
    labs(x = NULL,
         y = NULL,
         title = "Hvernig gengur sveitarfélögum að standast viðmið Eftirlitsnefndar með fjármálum sveitarfélaga (A og B-hluti)?",
         subtitle = "Brotin lína er viðmið og er reiknuð út frá nettóskuldum sem hlutfall af tekjum")


p

ggsave(plot = p,
       filename = "vidmid_eftirlitsnefndar_aogb.png",
       width = 8, height = 0.7 * 8, scale = 2, bg = "white")
```